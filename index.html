<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜¨ë¼ì¸ ê°•ì˜ì‹¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- PWA ì„¤ì • -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="GCU ê°•ì˜ì‹¤" />
  <link rel="icon" type="image/svg+xml" href="icons/icon.svg" />
  <link rel="apple-touch-icon" href="icons/icon.svg" />
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Noto Sans KR", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* ========== ë¡œê·¸ì¸ í™”ë©´ ========== */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .login-overlay.hidden {
      display: none;
    }

    .login-container {
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .login-header {
      text-align: center;
      margin-bottom: 28px;
    }

    .login-header h1 {
      font-size: 24px;
      margin: 0 0 8px 0;
      color: #f1f5f9;
    }

    .login-header p {
      font-size: 14px;
      color: #9ca3af;
      margin: 0;
    }

    .role-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }

    .role-btn {
      flex: 1;
      padding: 16px 12px;
      border: 2px solid #374151;
      border-radius: 12px;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .role-btn:hover {
      border-color: #4b5563;
      background: #1f2937;
    }

    .role-btn.active {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
      color: #60a5fa;
    }

    .role-btn.active.admin {
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.1);
      color: #a78bfa;
    }

    .role-btn .role-icon {
      font-size: 28px;
    }

    .role-btn .role-label {
      font-size: 13px;
      font-weight: 600;
    }

    .form-group.hidden {
      display: none;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .form-group input::placeholder {
      color: #6b7280;
    }

    .server-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 14px;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239ca3af'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
    }

    .server-select:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .server-select option {
      background: #1f2937;
      color: #e5e7eb;
    }

    .submit-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      margin-top: 8px;
    }

    .submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .submit-btn:active {
      transform: translateY(0);
    }

    .login-footer {
      text-align: center;
      margin-top: 20px;
      font-size: 12px;
      color: #6b7280;
    }

    .school-name {
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(90deg, #60a5fa, #a78bfa, #f472b6, #60a5fa);
      background-size: 300% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: sparkle 3s ease-in-out infinite;
    }

    @keyframes sparkle {
      0%, 100% {
        background-position: 0% 50%;
        filter: brightness(1);
      }
      50% {
        background-position: 100% 50%;
        filter: brightness(1.2);
      }
    }

    /* ========== ë©”ì¸ ë ˆì´ì•„ì›ƒ ========== */
    .main-app {
      display: none;
      flex-direction: column;
      height: 100%;
    }

    .main-app.show {
      display: flex;
    }

    header {
      padding: 10px 16px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    header .title {
      font-size: 18px;
      font-weight: 600;
    }

    header .subtitle {
      font-size: 12px;
      color: #9ca3af;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: #1f2937;
      border-radius: 8px;
      font-size: 13px;
    }

    .user-badge.professor {
      border: 1px solid #f59e0b;
      color: #fcd34d;
    }

    .user-badge.student {
      border: 1px solid #10b981;
      color: #6ee7b7;
    }

    .user-badge .badge-icon {
      font-size: 16px;
    }

    .logout-btn {
      padding: 6px 12px;
      border: 1px solid #ef4444;
      border-radius: 6px;
      background: transparent;
      color: #f87171;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    main {
      flex: 1;
      display: flex;
      padding: 8px;
      height: calc(100% - 56px);
    }

    section {
      flex: 1;
      width: 100%;
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 10px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .jitsi-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      position: relative;
    }

    .jitsi-header {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .room-name-display {
      font-weight: 500;
      color: #60a5fa;
    }

    .jitsi-frame {
      flex: 1;
      border: none;
      border-radius: 8px;
      background: black;
      width: 100%;
    }

    .small-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    @media (max-width: 900px) {
      .user-info {
        width: 100%;
        justify-content: space-between;
      }
    }

    /* ========== PWA ì„¤ì¹˜ ë²„íŠ¼ ========== */
    .install-btn {
      display: none;
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border: 2px dashed #10b981;
      border-radius: 10px;
      background: rgba(16, 185, 129, 0.1);
      color: #6ee7b7;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .install-btn:hover {
      background: rgba(16, 185, 129, 0.2);
      border-style: solid;
    }

    .install-btn.show {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .install-guide {
      display: none;
      margin-top: 12px;
      padding: 12px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid #3b82f6;
      border-radius: 8px;
      font-size: 12px;
      color: #93c5fd;
      text-align: center;
    }

    .install-guide.show {
      display: block;
    }

    /* ========== êµìˆ˜ ì»¨íŠ¸ë¡¤ ë°” ========== */
    .professor-controls {
      display: none;
      gap: 8px;
      padding: 10px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      flex-wrap: wrap;
    }

    .professor-controls.show {
      display: flex;
    }

    /* ========== í—¤ë” ë²„íŠ¼ (êµìˆ˜/í•™ìƒ) ========== */
    .professor-header-btns,
    .student-header-btns {
      display: none;
      gap: 6px;
      align-items: center;
    }

    .professor-header-btns.show,
    .student-header-btns.show {
      display: flex;
    }

    .header-btn {
      padding: 6px 10px;
      border: 1px solid #374151;
      border-radius: 6px;
      background: #1f2937;
      color: #e5e7eb;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .header-btn:hover {
      background: #374151;
    }

    .header-btn.primary {
      background: #2563eb;
      border-color: #2563eb;
      color: white;
    }

    .header-btn.primary:hover {
      background: #1d4ed8;
    }

    .header-btn.primary:disabled {
      background: #374151;
      border-color: #374151;
      color: #6b7280;
      cursor: not-allowed;
    }

    .header-btn.danger {
      background: #dc2626;
      border-color: #dc2626;
      color: white;
    }

    .header-btn.danger:hover {
      background: #b91c1c;
    }

    .header-btn.danger:disabled {
      background: #374151;
      border-color: #374151;
      color: #6b7280;
      cursor: not-allowed;
    }

    /* ìˆ˜ì—…ë…¹í™” ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .record-checkbox-label {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .record-checkbox-label:hover {
      background: #374151;
      border-color: #4b5563;
    }

    .record-checkbox-label input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #ef4444;
      cursor: pointer;
    }

    .record-checkbox-text {
      font-size: 12px;
      color: #e5e7eb;
      white-space: nowrap;
    }

    .record-checkbox-label:has(input:checked) {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.15);
    }

    .record-checkbox-label:has(input:checked) .record-checkbox-text {
      color: #fca5a5;
    }

    /* ë…¹í™”ì¤‘ ì¸ë””ì¼€ì´í„° */
    .recording-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 8px;
      padding: 4px 8px;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      border-radius: 4px;
      font-size: 11px;
      color: #fca5a5;
      animation: recording-pulse 1.5s ease-in-out infinite;
    }

    @keyframes recording-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ë…¹í™” ì¢…ë£Œ ë²„íŠ¼ */
    .stop-recording-btn {
      background: #dc2626 !important;
      border-color: #dc2626 !important;
      color: white !important;
      margin-left: 8px;
      animation: recording-pulse 1.5s ease-in-out infinite;
    }

    .stop-recording-btn:hover {
      background: #b91c1c !important;
    }

    .header-btn.success {
      background: #16a34a;
      border-color: #16a34a;
      color: white;
    }

    .header-btn.success:hover {
      background: #15803d;
    }

    .header-btn.success:disabled {
      background: #374151;
      border-color: #374151;
      color: #6b7280;
      cursor: not-allowed;
    }

    .header-status {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(15, 23, 42, 0.8);
      border-radius: 6px;
      font-size: 12px;
      color: #9ca3af;
    }

    .ctrl-btn {
      padding: 8px 16px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #1f2937;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ctrl-btn:hover {
      background: #374151;
    }

    .ctrl-btn.primary {
      background: #2563eb;
      border-color: #2563eb;
      color: white;
    }

    .ctrl-btn.primary:hover {
      background: #1d4ed8;
    }

    .ctrl-btn.danger {
      background: #dc2626;
      border-color: #dc2626;
      color: white;
    }

    .ctrl-btn.danger:hover {
      background: #b91c1c;
    }

    .ctrl-btn.success {
      background: #16a34a;
      border-color: #16a34a;
      color: white;
    }

    .ctrl-btn.success:hover {
      background: #15803d;
    }

    .ctrl-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .class-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #0f172a;
      border-radius: 8px;
      font-size: 13px;
      margin-left: auto;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #6b7280;
    }

    .status-dot.live {
      background: #22c55e;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ========== ëª¨ë‹¬ ========== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: #0f172a;
      border: 1px solid #1f2937;
      border-radius: 16px;
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 18px;
      color: #f1f5f9;
    }

    .modal-close {
      background: none;
      border: none;
      color: #9ca3af;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover {
      color: #f1f5f9;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #1f2937;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* ========== ìˆ˜ê°•ìƒ ê´€ë¦¬ ========== */
    .student-input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    .student-input-row input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }

    .student-input-row input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .student-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .student-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: #1f2937;
      border-radius: 8px;
    }

    .student-item .student-name {
      font-size: 14px;
    }

    .student-item .delete-btn {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
    }

    .student-item .delete-btn:hover {
      color: #f87171;
    }

    .empty-list {
      text-align: center;
      color: #6b7280;
      padding: 30px;
      font-size: 14px;
    }

    /* ========== ì¶œì„ë¶€ í…Œì´ë¸” ========== */
    .week-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .week-selector label {
      font-size: 14px;
      color: #9ca3af;
    }

    .week-selector select {
      padding: 8px 12px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }

    .attendance-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .attendance-table th,
    .attendance-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #1f2937;
    }

    .attendance-table th {
      background: #020617;
      color: #9ca3af;
      font-weight: 600;
    }

    .attendance-table tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    .attendance-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .attendance-status.present {
      background: rgba(34, 197, 94, 0.2);
      color: #4ade80;
    }

    .attendance-status.late {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .attendance-status.early-leave {
      background: rgba(249, 115, 22, 0.2);
      color: #fb923c;
    }

    .attendance-status.absent {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
    }

    .attendance-status.pending {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
    }

    .attendance-status.not-checked {
      background: rgba(75, 85, 99, 0.2);
      color: #6b7280;
      border: 1px dashed #4b5563;
    }

    .attendance-status.attending {
      background: rgba(59, 130, 246, 0.3);
      color: #60a5fa;
      animation: pulse-blue 2s infinite;
    }

    @keyframes pulse-blue {
      0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
      50% { box-shadow: 0 0 8px 2px rgba(59, 130, 246, 0.3); }
    }

    .attendance-status.partial {
      background: rgba(168, 85, 247, 0.2);
      color: #c084fc;
    }

    .time-info {
      font-size: 11px;
      color: #6b7280;
    }

    .attendance-summary {
      display: flex;
      gap: 16px;
      margin-top: 16px;
      padding: 12px;
      background: #020617;
      border-radius: 8px;
      flex-wrap: wrap;
    }

    .summary-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .summary-item .count {
      font-weight: 700;
    }

    /* ========== ìš´ì˜ì ë°°ì§€ ========== */
    .user-badge.admin {
      border: 1px solid #8b5cf6;
      color: #c4b5fd;
    }

    /* ========== ìš´ì˜ì ì»¨íŠ¸ë¡¤ ë°” ========== */
    .admin-controls {
      display: none;
      gap: 8px;
      padding: 10px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      flex-wrap: wrap;
    }

    .admin-controls.show {
      display: flex;
    }

    /* ========== ê°•ì˜ ê´€ë¦¬ ========== */
    .course-card {
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .course-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .course-card-title {
      font-size: 16px;
      font-weight: 600;
      color: #f1f5f9;
    }

    .course-card-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 13px;
      color: #9ca3af;
    }

    .course-card-info span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .course-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .admin-form-group {
      margin-bottom: 16px;
    }

    .admin-form-group label {
      display: block;
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .admin-form-group input,
    .admin-form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }

    .admin-form-group textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }

    .admin-form-group input:focus,
    .admin-form-group textarea:focus {
      outline: none;
      border-color: #8b5cf6;
    }

    .admin-form-group .help-text {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    .no-courses {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    /* ========== ì „ì²´ ì¶œì„ë¶€ ========== */
    .all-attendance-filters {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .all-attendance-filters select {
      padding: 8px 12px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }

    .course-attendance-section {
      background: #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .course-attendance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #374151;
    }

    .course-attendance-title {
      font-size: 16px;
      font-weight: 600;
      color: #f1f5f9;
    }

    .course-attendance-meta {
      font-size: 12px;
      color: #9ca3af;
    }

    .week-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .week-tab {
      padding: 6px 12px;
      border: 1px solid #374151;
      border-radius: 6px;
      background: transparent;
      color: #9ca3af;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .week-tab:hover {
      background: #374151;
    }

    .week-tab.active {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }

    .week-tab.has-data {
      border-color: #22c55e;
      color: #4ade80;
    }

    .week-tab.has-data.active {
      background: #16a34a;
      border-color: #16a34a;
      color: white;
    }

    .mini-attendance-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .mini-attendance-table th,
    .mini-attendance-table td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #374151;
    }

    .mini-attendance-table th {
      background: #0f172a;
      color: #9ca3af;
      font-weight: 600;
    }

    .mini-attendance-table tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    .export-all-btn {
      margin-left: auto;
    }

    /* ========== ì˜ìƒí¸ì§‘ ëª¨ë‹¬ ========== */
    .video-editor-modal {
      max-width: 900px;
      max-height: 95vh;
    }

    .video-editor-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      background: #1e293b;
      padding: 6px;
      border-radius: 12px;
    }

    .video-editor-tab {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: #9ca3af;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .video-editor-tab:hover {
      background: #374151;
      color: #e5e7eb;
    }

    .video-editor-tab.active {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .video-editor-tab-icon {
      font-size: 18px;
    }

    .video-editor-panel {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .video-editor-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .video-drop-zone {
      border: 2px dashed #374151;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      background: #0f172a;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 16px;
    }

    .video-drop-zone:hover {
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.05);
    }

    .video-drop-zone.dragover {
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.1);
      transform: scale(1.02);
    }

    .video-drop-zone-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .video-drop-zone-text {
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .video-drop-zone-hint {
      font-size: 12px;
      color: #6b7280;
    }

    .video-file-input {
      display: none;
    }

    .video-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
      max-height: 200px;
      overflow-y: auto;
    }

    .video-list-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: #1e293b;
      border-radius: 8px;
      border: 1px solid #374151;
    }

    .video-list-item .video-icon {
      font-size: 24px;
    }

    .video-list-item .video-info {
      flex: 1;
      min-width: 0;
    }

    .video-list-item .video-name {
      font-size: 14px;
      color: #f1f5f9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .video-list-item .video-size {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }

    .video-list-item .video-order {
      display: flex;
      gap: 4px;
    }

    .video-list-item .order-btn {
      padding: 4px 8px;
      border: 1px solid #374151;
      border-radius: 4px;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      font-size: 12px;
    }

    .video-list-item .order-btn:hover {
      background: #374151;
      color: #f1f5f9;
    }

    .video-list-item .delete-btn {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
      cursor: pointer;
      font-size: 14px;
    }

    .video-list-item .delete-btn:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    .video-preview-container {
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
      position: relative;
    }

    .video-preview-container video {
      width: 100%;
      max-height: 300px;
      display: block;
    }

    .video-trim-controls {
      padding: 16px;
      background: #1e293b;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .video-timeline {
      position: relative;
      height: 60px;
      background: #374151;
      border-radius: 8px;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .video-timeline-progress {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: rgba(139, 92, 246, 0.3);
      pointer-events: none;
    }

    .video-timeline-range {
      position: absolute;
      top: 0;
      height: 100%;
      background: rgba(139, 92, 246, 0.5);
      border-left: 3px solid #8b5cf6;
      border-right: 3px solid #8b5cf6;
    }

    .video-timeline-handle {
      position: absolute;
      top: 0;
      width: 16px;
      height: 100%;
      background: #8b5cf6;
      cursor: ew-resize;
      border-radius: 4px;
    }

    .video-timeline-handle.start {
      left: 0;
    }

    .video-timeline-handle.end {
      right: 0;
    }

    .video-time-inputs {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .video-time-input-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .video-time-input-group label {
      font-size: 13px;
      color: #9ca3af;
    }

    .video-time-input-group input {
      width: 80px;
      padding: 8px 10px;
      border: 1px solid #374151;
      border-radius: 6px;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 13px;
      text-align: center;
    }

    .video-volume-control {
      padding: 16px;
      background: #1e293b;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .volume-slider-container {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 12px;
    }

    .volume-icon {
      font-size: 24px;
    }

    .volume-slider {
      flex: 1;
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: #374151;
      border-radius: 4px;
      outline: none;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
    }

    .volume-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    .volume-value {
      font-size: 16px;
      font-weight: 600;
      color: #8b5cf6;
      min-width: 50px;
      text-align: center;
    }

    .video-action-btn {
      width: 100%;
      padding: 14px 20px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .video-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
    }

    .video-action-btn:disabled {
      background: #374151;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .video-progress {
      margin-top: 16px;
      padding: 16px;
      background: #1e293b;
      border-radius: 12px;
      display: none;
    }

    .video-progress.show {
      display: block;
    }

    .video-progress-bar {
      height: 8px;
      background: #374151;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .video-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #8b5cf6, #6366f1);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .video-progress-text {
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
    }

    .split-options {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .split-option {
      flex: 1;
      padding: 16px;
      border: 2px solid #374151;
      border-radius: 12px;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .split-option:hover {
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.05);
    }

    .split-option.active {
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.1);
      color: #f1f5f9;
    }

    .split-option-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .split-option-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .split-option-desc {
      font-size: 12px;
      color: #6b7280;
    }

    .split-count-input {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .split-count-input label {
      font-size: 14px;
      color: #9ca3af;
    }

    .split-count-input input {
      width: 80px;
      padding: 10px;
      border: 1px solid #374151;
      border-radius: 8px;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 14px;
      text-align: center;
    }

    .video-editor-info {
      padding: 12px 16px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      font-size: 13px;
      color: #93c5fd;
      margin-bottom: 16px;
    }

    .video-editor-info-icon {
      margin-right: 8px;
    }
  </style>
</head>
<body>

  <!-- ========== ë¡œê·¸ì¸ í™”ë©´ ========== -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-container">
      <div class="login-header">
        <h1>ğŸ“ ì˜¨ë¼ì¸ ê°•ì˜ì‹¤ ğŸ“</h1>
    </div>

      <!-- ì—­í•  ì„ íƒ -->
      <div class="role-selector">
        <button type="button" class="role-btn" id="btnAdmin" onclick="selectRole('admin')">
          <span class="role-icon">âš™ï¸</span>
          <span class="role-label">ìš´ì˜</span>
        </button>
        <button type="button" class="role-btn" id="btnProfessor" onclick="selectRole('professor')">
          <span class="role-icon">ğŸ‘¨â€ğŸ«</span>
          <span class="role-label">êµìˆ˜</span>
        </button>
        <button type="button" class="role-btn active" id="btnStudent" onclick="selectRole('student')">
          <span class="role-icon">ğŸ‘¨â€ğŸ“</span>
          <span class="role-label">í•™ìƒ</span>
        </button>
      </div>

      <!-- ì…ë ¥ í¼ -->
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="inputName" id="labelName">ì´ë¦„ *</label>
          <input type="text" id="inputName" placeholder="í™ê¸¸ë™" required />
        </div>

        <div class="form-group hidden" id="groupEmployeeId">
          <label for="inputEmployeeId" id="labelEmployeeId">ì‚¬ë²ˆ *</label>
          <input type="password" id="inputEmployeeId" placeholder="ì‚¬ë²ˆ ì…ë ¥" />
        </div>

        <div class="form-group" id="groupCourse">
          <label for="inputCourse">ê°•ì˜ëª… *</label>
          <input type="text" id="inputCourse" placeholder="ì˜ˆ: ì„±ê²½ê°œë¡ " required />
        </div>

        <div class="form-group" style="display:none;">
          <label for="serverSelect">ì„œë²„ ì„ íƒ</label>
          <select id="serverSelect" class="server-select">
            <option value="https://meet.ffmuc.net">ë…ì¼ ì„œë²„ (meet.ffmuc.net)</option>
            <option value="https://meet.jit.si">Jitsi ê¸°ë³¸ (meet.jit.si)</option>
            <option value="https://jitsi.riot.im">Riot ì„œë²„ (jitsi.riot.im)</option>
            <option value="https://meet.scheible.it">Scheible ì„œë²„ (meet.scheible.it)</option>
          </select>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          ğŸš€ ê°•ì˜ì‹¤ ì…ì¥
        </button>
        
        <button type="button" class="submit-btn" style="background:#374151;margin-top:8px;" onclick="testMicrophonePermission()">
          ğŸ¤ ë§ˆì´í¬ í…ŒìŠ¤íŠ¸
        </button>
    </form>

      <!-- PWA ì„¤ì¹˜ ë²„íŠ¼ -->
      <button type="button" class="install-btn" id="installBtn" onclick="installApp()">
        ğŸ“² í™ˆ í™”ë©´ì— ì•± ì¶”ê°€
      </button>
      
      <!-- iOS ì„¤ì¹˜ ê°€ì´ë“œ -->
      <div class="install-guide" id="iosGuide">
        ğŸ“± iPhone/iPad: í•˜ë‹¨ì˜ <b>ê³µìœ  ë²„íŠ¼</b> â†’ <b>"í™ˆ í™”ë©´ì— ì¶”ê°€"</b>ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”
      </div>

      <div class="login-footer">
        <span class="school-name">ê¹€ì²œëŒ€í•™êµ ìƒë‹´ì‹¬ë¦¬í•™ê³¼</span>
        <div id="firebaseStatus" style="margin-top: 8px; font-size: 11px;"></div>
      </div>
    </div>
      </div>

  <!-- ========== ë©”ì¸ ì•± ========== -->
  <div class="main-app" id="mainApp">
    <header>
      <div class="header-left">
        <div class="title"><span class="school-name">ê¹€ì²œëŒ€í•™êµ ìƒë‹´ì‹¬ë¦¬í•™ê³¼</span> ê°•ì˜ì‹¤</div>
      </div>

      <div class="user-info">
        <!-- êµìˆ˜ ì „ìš© ë²„íŠ¼ (ë°°ì§€ ì™¼ìª½) -->
        <div class="professor-header-btns" id="professorHeaderBtns">
          <label class="record-checkbox-label" title="ìˆ˜ì—… ì‹œì‘ê³¼ ë™ì‹œì— í™”ë©´ì„ ë…¹í™”í•©ë‹ˆë‹¤">
            <input type="checkbox" id="chkRecordClass" checked>
            <span class="record-checkbox-text">ğŸ¥ ìˆ˜ì—…ë…¹í™”</span>
          </label>
          <button class="header-btn primary" id="btnStartClass" onclick="startClass()">â–¶ï¸ ìˆ˜ì—…ì‹œì‘</button>
          <button class="header-btn danger" id="btnEndClass" onclick="endClass()" disabled>â¹ï¸ ìˆ˜ì—…ì¢…ë£Œ</button>
          <button class="header-btn" onclick="openAttendanceModal()">ğŸ“‹ ì¶œì„ë¶€</button>
          <button class="header-btn" onclick="openProfCourseModal()">ğŸ“š ê°•ì˜ê´€ë¦¬</button>
          <button class="header-btn" onclick="openVideoEditorModal()" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); border-color: #8b5cf6;">ğŸ¬ ì˜ìƒí¸ì§‘</button>
          <span class="header-status" id="headerClassStatus">
            <span class="status-dot" id="statusDot"></span>
            <span id="classStatusText">ìˆ˜ì—… ëŒ€ê¸°ì¤‘</span>
            <span class="recording-indicator" id="recordingIndicator" style="display:none;">ğŸ”´ ë…¹í™”ì¤‘</span>
            <button class="header-btn stop-recording-btn" id="btnStopRecording" onclick="stopRecordingManual()" style="display:none;">â¹ï¸ ë…¹í™”ì¢…ë£Œ</button>
          </span>
      </div>
        <!-- í•™ìƒ ì „ìš© ë²„íŠ¼ (ë°°ì§€ ì™¼ìª½) -->
        <div class="student-header-btns" id="studentHeaderBtns">
          <button class="header-btn" onclick="openMyAttendanceModal()">ğŸ“‹ ë‚´ ì¶œì„í˜„í™©</button>
          <button class="header-btn success" id="btnCheckIn" onclick="studentCheckIn()">âœ‹ ì¶œì„í•˜ê¸°</button>
        </div>
        <div class="user-badge" id="userBadge">
          <span class="badge-icon" id="badgeIcon">ğŸ‘¨â€ğŸ«</span>
          <span id="badgeText">CHOI JUNIL êµìˆ˜</span>
        </div>
        <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </header>

    <!-- ìš´ì˜ì ì „ìš© ì»¨íŠ¸ë¡¤ ë°” -->
    <div class="admin-controls" id="adminControls">
      <button class="ctrl-btn primary" onclick="openCourseModal()">
        ğŸ“š ê°•ì˜ ê´€ë¦¬
      </button>
      <button class="ctrl-btn" onclick="openAllAttendanceModal()">
        ğŸ“‹ ì „ì²´ ì¶œì„ë¶€
      </button>
      <button class="ctrl-btn" onclick="checkFirebaseStatus()" style="margin-left:auto;">
        ğŸ” Firebase ì§„ë‹¨
      </button>
    </div>

    <main>
      <!-- Jitsi ì˜ìƒì˜ì—­ -->
    <section>
      <div class="jitsi-wrapper">
        <div class="jitsi-header">
          <div>
              í˜„ì¬ ê°•ì˜ëª…: <span class="room-name-display" id="roomNameDisplay">-</span>
              <span id="serverStatus" style="margin-left: 12px; font-size: 12px; color: #60a5fa;"></span>
          </div>
          <div class="small-note" style="color:#fbbf24;">
            ğŸ¤ ë§ˆì´í¬/ì¹´ë©”ë¼ ê¶Œí•œì„ <b style="color:#4ade80;">ë°˜ë“œì‹œ í—ˆìš©</b>í•´ì£¼ì„¸ìš”! (ì£¼ì†Œì°½ ì™¼ìª½ ğŸ”’ í´ë¦­)
          </div>
        </div>

        <!-- ë¡œë”©/ë””ë²„ê·¸ í‘œì‹œ -->
        <div id="jitsiLoading" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; color:#9ca3af; z-index:10;">
          <div style="width:50px; height:50px; border:4px solid #374151; border-top:4px solid #60a5fa; border-radius:50%; margin:0 auto 20px; animation:spin 1s linear infinite;"></div>
          <p>ê°•ì˜ì‹¤ì— ì ‘ì† ì¤‘ì…ë‹ˆë‹¤...</p>
          <p id="debugInfo" style="font-size:11px; margin-top:10px; color:#6b7280;"></p>
        </div>
        <style>@keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }</style>

        <!-- Jitsi IFrame -->
        <iframe
          id="jitsiFrame"
          class="jitsi-frame"
          allow="camera; microphone; fullscreen; display-capture"
          src=""
          onload="onJitsiLoaded()"
        ></iframe>
      </div>
    </section>
  </main>
  </div>

  <!-- ========== ìˆ˜ê°•ìƒ ê´€ë¦¬ ëª¨ë‹¬ ========== -->
  <div class="modal-overlay" id="studentModal">
    <div class="modal">
      <div class="modal-header">
        <h2>ğŸ‘¥ ìˆ˜ê°•ìƒ ê´€ë¦¬</h2>
        <button class="modal-close" onclick="closeStudentModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="student-input-row">
          <input type="text" id="newStudentName" placeholder="ìˆ˜ê°•ìƒ ì´ë¦„ ì…ë ¥" onkeypress="handleStudentKeypress(event)" />
          <button class="ctrl-btn primary" onclick="addStudent()">ì¶”ê°€</button>
        </div>
        <div class="student-list" id="studentList">
          <div class="empty-list">ë“±ë¡ëœ ìˆ˜ê°•ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="ctrl-btn" onclick="closeStudentModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ========== ì¶œì„ë¶€ ëª¨ë‹¬ ========== -->
  <div class="modal-overlay" id="attendanceModal">
    <div class="modal" style="max-width: 900px;">
      <div class="modal-header">
        <h2>ğŸ“‹ ì¶œì„ë¶€</h2>
        <button class="modal-close" onclick="closeAttendanceModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="week-selector">
          <label>ì£¼ì°¨ ì„ íƒ:</label>
          <select id="weekSelect" onchange="renderAttendanceTable()">
            <option value="1">1ì£¼ì°¨</option>
            <option value="2">2ì£¼ì°¨</option>
            <option value="3">3ì£¼ì°¨</option>
            <option value="4">4ì£¼ì°¨</option>
            <option value="5">5ì£¼ì°¨</option>
            <option value="6">6ì£¼ì°¨</option>
            <option value="7">7ì£¼ì°¨</option>
            <option value="8">8ì£¼ì°¨</option>
            <option value="9">9ì£¼ì°¨</option>
            <option value="10">10ì£¼ì°¨</option>
            <option value="11">11ì£¼ì°¨</option>
            <option value="12">12ì£¼ì°¨</option>
            <option value="13">13ì£¼ì°¨</option>
            <option value="14">14ì£¼ì°¨</option>
            <option value="15">15ì£¼ì°¨</option>
            <option value="16">16ì£¼ì°¨</option>
          </select>
          <button class="ctrl-btn" onclick="exportAttendance()">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
        </div>
        <table class="attendance-table">
          <thead>
            <tr>
              <th>ë²ˆí˜¸</th>
              <th>ì´ë¦„</th>
              <th>ì…ì¥ì‹œê°„</th>
              <th>í‡´ì¥ì‹œê°„</th>
              <th>ì¶œì„ìƒíƒœ</th>
            </tr>
          </thead>
          <tbody id="attendanceTableBody">
          </tbody>
        </table>
        <div class="attendance-summary" id="attendanceSummary">
        </div>
      </div>
      <div class="modal-footer">
        <button class="ctrl-btn" onclick="closeAttendanceModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ========== ê°•ì˜ ê´€ë¦¬ ëª¨ë‹¬ (ìš´ì˜ììš©) ========== -->
  <div class="modal-overlay" id="courseModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2>ğŸ“š ê°•ì˜ ê´€ë¦¬</h2>
        <button class="modal-close" onclick="closeCourseModal()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- ê°•ì˜ ì¶”ê°€ í¼ -->
        <div style="background:#1e293b;padding:16px;border-radius:12px;margin-bottom:20px;">
          <h3 style="margin:0 0 16px 0;font-size:15px;color:#f1f5f9;">â• ìƒˆ ê°•ì˜ ë“±ë¡</h3>
          <div class="admin-form-group">
            <label>ê°•ì˜ëª… *</label>
            <input type="text" id="newCourseName" placeholder="ì˜ˆ: ì„±ê²½ê°œë¡ " />
          </div>
          <div class="admin-form-group">
            <label>ë‹´ë‹¹êµìˆ˜ëª… *</label>
            <input type="text" id="newProfessorName" placeholder="ì˜ˆ: í™ê¸¸ë™" />
          </div>
          <div class="admin-form-group">
            <label>ìˆ˜ê°•ìƒ ëª…ë‹¨</label>
            <textarea id="newStudentList" placeholder="í•œ ì¤„ì— í•œ ëª…ì”© ì…ë ¥&#10;ì˜ˆ:&#10;ê¹€ì² ìˆ˜&#10;ì´ì˜í¬&#10;ë°•ë¯¼ìˆ˜"></textarea>
            <div class="help-text">í•œ ì¤„ì— í•œ ëª…ì”© ì…ë ¥í•´ì£¼ì„¸ìš”</div>
          </div>
          <button class="ctrl-btn success" onclick="addCourse()" style="width:100%;">ê°•ì˜ ë“±ë¡</button>
        </div>

        <!-- ë“±ë¡ëœ ê°•ì˜ ëª©ë¡ -->
        <h3 style="margin:0 0 12px 0;font-size:15px;color:#9ca3af;">ğŸ“‹ ë“±ë¡ëœ ê°•ì˜ ëª©ë¡</h3>
        <div id="courseList">
          <div class="no-courses">ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="ctrl-btn" onclick="closeCourseModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ========== ê°•ì˜ ìˆ˜ì • ëª¨ë‹¬ ========== -->
  <div class="modal-overlay" id="editCourseModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2>âœï¸ ê°•ì˜ ìˆ˜ì •</h2>
        <button class="modal-close" onclick="closeEditCourseModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editCourseId" />
        <div class="admin-form-group">
          <label>ê°•ì˜ëª… *</label>
          <input type="text" id="editCourseName" />
        </div>
        <div class="admin-form-group">
          <label>ë‹´ë‹¹êµìˆ˜ëª… *</label>
          <input type="text" id="editProfessorName" />
        </div>
        <div class="admin-form-group">
          <label>ìˆ˜ê°•ìƒ ëª…ë‹¨</label>
          <textarea id="editStudentList"></textarea>
          <div class="help-text">í•œ ì¤„ì— í•œ ëª…ì”© ì…ë ¥í•´ì£¼ì„¸ìš”</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="ctrl-btn" onclick="closeEditCourseModal()">ì·¨ì†Œ</button>
        <button class="ctrl-btn primary" onclick="saveCourseEdit()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ========== ì „ì²´ ì¶œì„ë¶€ ëª¨ë‹¬ (ìš´ì˜ììš©) ========== -->
  <div class="modal-overlay" id="allAttendanceModal">
    <div class="modal" style="max-width: 1000px; max-height: 95vh;">
      <div class="modal-header">
        <h2>ğŸ“‹ ì „ì²´ ì¶œì„ë¶€</h2>
        <button class="modal-close" onclick="closeAllAttendanceModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="all-attendance-filters">
          <label style="font-size:14px;color:#9ca3af;">ê°•ì˜ ì„ íƒ:</label>
          <select id="allAttendanceCourseSelect" onchange="renderAllAttendance()">
            <option value="all">ì „ì²´ ê°•ì˜</option>
          </select>
          <label style="font-size:14px;color:#9ca3af;margin-left:12px;">ì£¼ì°¨:</label>
          <select id="allAttendanceWeekSelect" onchange="renderAllAttendance()">
            <option value="all">ì „ì²´ ì£¼ì°¨</option>
            <option value="1">1ì£¼ì°¨</option>
            <option value="2">2ì£¼ì°¨</option>
            <option value="3">3ì£¼ì°¨</option>
            <option value="4">4ì£¼ì°¨</option>
            <option value="5">5ì£¼ì°¨</option>
            <option value="6">6ì£¼ì°¨</option>
            <option value="7">7ì£¼ì°¨</option>
            <option value="8">8ì£¼ì°¨</option>
            <option value="9">9ì£¼ì°¨</option>
            <option value="10">10ì£¼ì°¨</option>
            <option value="11">11ì£¼ì°¨</option>
            <option value="12">12ì£¼ì°¨</option>
            <option value="13">13ì£¼ì°¨</option>
            <option value="14">14ì£¼ì°¨</option>
            <option value="15">15ì£¼ì°¨</option>
            <option value="16">16ì£¼ì°¨</option>
          </select>
          <button class="ctrl-btn export-all-btn" onclick="exportAllAttendance()">ğŸ“¥ ì „ì²´ ë‚´ë³´ë‚´ê¸°</button>
        </div>
        <div id="allAttendanceContent">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="ctrl-btn" onclick="closeAllAttendanceModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ========== ë‚´ ì¶œì„í˜„í™© ëª¨ë‹¬ (í•™ìƒìš©) ========== -->
  <div class="modal-overlay" id="myAttendanceModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2>ğŸ“‹ ë‚´ ì¶œì„í˜„í™©</h2>
        <button class="modal-close" onclick="closeMyAttendanceModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="myAttendanceInfo" style="margin-bottom: 16px;">
          <div style="font-size: 14px; color: #9ca3af;">ê°•ì˜ëª…</div>
          <div style="font-size: 18px; font-weight: 600; color: #60a5fa;" id="myCourseName">-</div>
        </div>
        <div id="myAttendanceSummary" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
          <!-- ë™ì  ìƒì„± -->
        </div>
        <div id="myAttendanceList">
          <!-- ë™ì  ìƒì„± -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="ctrl-btn" onclick="closeMyAttendanceModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ========== ê°•ì˜ ê´€ë¦¬ ëª¨ë‹¬ (êµìˆ˜ìš©) ========== -->
  <div class="modal-overlay" id="profCourseModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2>ğŸ“š ë‚´ ê°•ì˜ ê´€ë¦¬</h2>
        <button class="modal-close" onclick="closeProfCourseModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="background:#1e293b;padding:16px;border-radius:12px;margin-bottom:16px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <span style="font-size:32px;">ğŸ“–</span>
            <div>
              <div style="font-size:14px;color:#9ca3af;">í˜„ì¬ ê°•ì˜</div>
              <div style="font-size:20px;font-weight:600;color:#60a5fa;" id="profCourseName">-</div>
            </div>
          </div>
          <div style="display:flex;gap:20px;font-size:14px;color:#9ca3af;">
            <span>ğŸ‘¨â€ğŸ« ë‹´ë‹¹: <strong style="color:#f1f5f9;" id="profCourseProf">-</strong></span>
            <span>ğŸ‘¥ ìˆ˜ê°•ìƒ: <strong style="color:#f1f5f9;" id="profCourseCount">0</strong>ëª…</span>
          </div>
        </div>
        
        <div class="admin-form-group">
          <label style="font-size:15px;font-weight:600;color:#f1f5f9;">ğŸ“ ìˆ˜ê°•ìƒ ëª…ë‹¨ ê´€ë¦¬</label>
          <textarea id="profStudentList" style="min-height:200px;"></textarea>
          <div class="help-text">í•œ ì¤„ì— í•œ ëª…ì”© ì…ë ¥í•´ì£¼ì„¸ìš”. í•™ìƒ ì¶”ê°€/ì‚­ì œ í›„ ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="ctrl-btn" onclick="closeProfCourseModal()">ì·¨ì†Œ</button>
        <button class="ctrl-btn success" onclick="saveProfCourseEdit()">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ========== ì˜ìƒí¸ì§‘ ëª¨ë‹¬ (êµìˆ˜ìš©) ========== -->
  <div class="modal-overlay" id="videoEditorModal">
    <div class="modal video-editor-modal">
      <div class="modal-header">
        <h2>ğŸ¬ ì˜ìƒí¸ì§‘ ë„êµ¬</h2>
        <button class="modal-close" onclick="closeVideoEditorModal()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="video-editor-tabs">
          <button class="video-editor-tab active" onclick="switchVideoTab('merge')">
            <span class="video-editor-tab-icon">ğŸ”—</span>
            <span>ì˜ìƒê²°í•©</span>
          </button>
          <button class="video-editor-tab" onclick="switchVideoTab('split')">
            <span class="video-editor-tab-icon">âœ‚ï¸</span>
            <span>ì˜ìƒë¶„ë¦¬</span>
          </button>
          <button class="video-editor-tab" onclick="switchVideoTab('trim')">
            <span class="video-editor-tab-icon">ğŸ¯</span>
            <span>íŠ¸ë¦¼&ìë¥´ê¸°</span>
          </button>
          <button class="video-editor-tab" onclick="switchVideoTab('volume')">
            <span class="video-editor-tab-icon">ğŸ”Š</span>
            <span>ì†Œë¦¬í‚¤ì›€</span>
          </button>
        </div>

        <!-- ì˜ìƒê²°í•© íŒ¨ë„ -->
        <div class="video-editor-panel active" id="panelMerge">
          <div class="video-editor-info">
            <span class="video-editor-info-icon">ğŸ’¡</span>
            ì—¬ëŸ¬ ì˜ìƒì„ í•˜ë‚˜ë¡œ í•©ì¹©ë‹ˆë‹¤. ìˆœì„œë¥¼ ë³€ê²½í•˜ë ¤ë©´ â¬†ï¸â¬‡ï¸ ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”.
          </div>
          
          <div class="video-drop-zone" id="mergeDropZone" onclick="document.getElementById('mergeFileInput').click()">
            <div class="video-drop-zone-icon">ğŸ“¹</div>
            <div class="video-drop-zone-text">ì˜ìƒ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì¶”ê°€</div>
            <div class="video-drop-zone-hint">MP4, WebM, AVI ì§€ì› (ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ ê°€ëŠ¥)</div>
          </div>
          <input type="file" class="video-file-input" id="mergeFileInput" accept="video/*" multiple onchange="handleMergeFiles(event)">
          
          <div class="video-list" id="mergeVideoList"></div>
          
          <button class="video-action-btn" id="btnMergeVideos" onclick="mergeVideos()" disabled>
            ğŸ”— ì˜ìƒ ê²°í•©í•˜ê¸°
          </button>
          
          <div class="video-progress" id="mergeProgress">
            <div class="video-progress-bar">
              <div class="video-progress-fill" id="mergeProgressFill" style="width: 0%"></div>
            </div>
            <div class="video-progress-text" id="mergeProgressText">ì²˜ë¦¬ ì¤‘...</div>
          </div>
        </div>

        <!-- ì˜ìƒë¶„ë¦¬ íŒ¨ë„ -->
        <div class="video-editor-panel" id="panelSplit">
          <div class="video-editor-info">
            <span class="video-editor-info-icon">ğŸ’¡</span>
            ì˜ìƒì„ ì—¬ëŸ¬ ê°œë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤. ì‹œê°„ ë˜ëŠ” ê°œìˆ˜ë¡œ ë‚˜ëˆŒ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
          
          <div class="video-drop-zone" id="splitDropZone" onclick="document.getElementById('splitFileInput').click()">
            <div class="video-drop-zone-icon">ğŸ“¹</div>
            <div class="video-drop-zone-text">ë¶„ë¦¬í•  ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
            <div class="video-drop-zone-hint">MP4, WebM, AVI ì§€ì›</div>
          </div>
          <input type="file" class="video-file-input" id="splitFileInput" accept="video/*" onchange="handleSplitFile(event)">
          
          <div class="video-preview-container" id="splitPreviewContainer" style="display:none;">
            <video id="splitPreview" controls></video>
          </div>
          
          <div id="splitVideoInfo" style="display:none;">
            <div style="padding:12px 16px;background:#1e293b;border-radius:8px;margin-bottom:16px;">
              <span style="color:#9ca3af;">ì„ íƒëœ íŒŒì¼:</span>
              <strong style="color:#f1f5f9;" id="splitFileName">-</strong>
              <span style="color:#6b7280;margin-left:12px;" id="splitFileDuration">-</span>
            </div>
            
            <div class="split-options">
              <button class="split-option active" onclick="selectSplitOption('count')">
                <div class="split-option-icon">ğŸ”¢</div>
                <div class="split-option-title">ê°œìˆ˜ë¡œ ë¶„ë¦¬</div>
                <div class="split-option-desc">ì˜ìƒì„ Nê°œë¡œ ê· ë“± ë¶„í• </div>
              </button>
              <button class="split-option" onclick="selectSplitOption('time')">
                <div class="split-option-icon">â±ï¸</div>
                <div class="split-option-title">ì‹œê°„ìœ¼ë¡œ ë¶„ë¦¬</div>
                <div class="split-option-desc">ì§€ì •í•œ ì‹œê°„ë§ˆë‹¤ ë¶„í• </div>
              </button>
            </div>
            
            <div class="split-count-input" id="splitCountInput">
              <label>ë¶„í•  ê°œìˆ˜:</label>
              <input type="number" id="splitCount" value="2" min="2" max="10">
              <span style="color:#6b7280;font-size:13px;">ê°œ</span>
            </div>
            
            <div class="split-count-input" id="splitTimeInput" style="display:none;">
              <label>ë¶„í•  ê°„ê²©:</label>
              <input type="number" id="splitInterval" value="300" min="10">
              <span style="color:#6b7280;font-size:13px;">ì´ˆ (5ë¶„=300ì´ˆ)</span>
            </div>
          </div>
          
          <button class="video-action-btn" id="btnSplitVideo" onclick="splitVideo()" disabled>
            âœ‚ï¸ ì˜ìƒ ë¶„ë¦¬í•˜ê¸°
          </button>
          
          <div class="video-progress" id="splitProgress">
            <div class="video-progress-bar">
              <div class="video-progress-fill" id="splitProgressFill" style="width: 0%"></div>
            </div>
            <div class="video-progress-text" id="splitProgressText">ì²˜ë¦¬ ì¤‘...</div>
          </div>
        </div>

        <!-- íŠ¸ë¦¼&ìë¥´ê¸° íŒ¨ë„ -->
        <div class="video-editor-panel" id="panelTrim">
          <div class="video-editor-info">
            <span class="video-editor-info-icon">ğŸ’¡</span>
            ì˜ìƒì˜ ì‹œì‘ê³¼ ëì„ ì˜ë¼ ì›í•˜ëŠ” ë¶€ë¶„ë§Œ ì¶”ì¶œí•©ë‹ˆë‹¤.
          </div>
          
          <div class="video-drop-zone" id="trimDropZone" onclick="document.getElementById('trimFileInput').click()">
            <div class="video-drop-zone-icon">ğŸ“¹</div>
            <div class="video-drop-zone-text">ìë¥¼ ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
            <div class="video-drop-zone-hint">MP4, WebM, AVI ì§€ì›</div>
          </div>
          <input type="file" class="video-file-input" id="trimFileInput" accept="video/*" onchange="handleTrimFile(event)">
          
          <div class="video-preview-container" id="trimPreviewContainer" style="display:none;">
            <video id="trimPreview" controls></video>
          </div>
          
          <div class="video-trim-controls" id="trimControls" style="display:none;">
            <div style="margin-bottom:12px;color:#9ca3af;font-size:13px;">
              ğŸ¬ ì „ì²´ ê¸¸ì´: <strong style="color:#f1f5f9;" id="trimTotalDuration">-</strong>
            </div>
            
            <div class="video-time-inputs">
              <div class="video-time-input-group">
                <label>ì‹œì‘ ì‹œê°„:</label>
                <input type="text" id="trimStartTime" value="00:00:00" placeholder="00:00:00" onchange="updateTrimPreview()">
              </div>
              <div class="video-time-input-group">
                <label>ì¢…ë£Œ ì‹œê°„:</label>
                <input type="text" id="trimEndTime" value="00:00:00" placeholder="00:00:00" onchange="updateTrimPreview()">
              </div>
              <div class="video-time-input-group">
                <span style="color:#8b5cf6;font-weight:600;" id="trimDurationDisplay">ì¶”ì¶œ ê¸¸ì´: -</span>
              </div>
            </div>
            
            <div style="margin-top:12px;display:flex;gap:8px;">
              <button class="ctrl-btn" onclick="setTrimStart()">â®ï¸ í˜„ì¬ ìœ„ì¹˜ë¥¼ ì‹œì‘ì ìœ¼ë¡œ</button>
              <button class="ctrl-btn" onclick="setTrimEnd()">â­ï¸ í˜„ì¬ ìœ„ì¹˜ë¥¼ ì¢…ë£Œì ìœ¼ë¡œ</button>
            </div>
          </div>
          
          <button class="video-action-btn" id="btnTrimVideo" onclick="trimVideo()" disabled>
            ğŸ¯ ì˜ìƒ ìë¥´ê¸°
          </button>
          
          <div class="video-progress" id="trimProgress">
            <div class="video-progress-bar">
              <div class="video-progress-fill" id="trimProgressFill" style="width: 0%"></div>
            </div>
            <div class="video-progress-text" id="trimProgressText">ì²˜ë¦¬ ì¤‘...</div>
          </div>
        </div>

        <!-- ì†Œë¦¬í‚¤ì›€ íŒ¨ë„ -->
        <div class="video-editor-panel" id="panelVolume">
          <div class="video-editor-info">
            <span class="video-editor-info-icon">ğŸ’¡</span>
            ì˜ìƒì˜ ì†Œë¦¬ë¥¼ í‚¤ì›ë‹ˆë‹¤. ë…¹í™”ëœ ê°•ì˜ ì†Œë¦¬ê°€ ì‘ì„ ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.
          </div>
          
          <div class="video-drop-zone" id="volumeDropZone" onclick="document.getElementById('volumeFileInput').click()">
            <div class="video-drop-zone-icon">ğŸ“¹</div>
            <div class="video-drop-zone-text">ì†Œë¦¬ë¥¼ í‚¤ìš¸ ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
            <div class="video-drop-zone-hint">MP4, WebM, AVI ì§€ì›</div>
          </div>
          <input type="file" class="video-file-input" id="volumeFileInput" accept="video/*" onchange="handleVolumeFile(event)">
          
          <div class="video-preview-container" id="volumePreviewContainer" style="display:none;">
            <video id="volumePreview" controls></video>
          </div>
          
          <div class="video-volume-control" id="volumeControls" style="display:none;">
            <div style="color:#f1f5f9;font-size:14px;margin-bottom:8px;">ğŸ”Š ë³¼ë¥¨ ì¦í­</div>
            <div class="volume-slider-container">
              <span class="volume-icon">ğŸ”ˆ</span>
              <input type="range" class="volume-slider" id="volumeSlider" min="100" max="400" value="200" oninput="updateVolumeDisplay()">
              <span class="volume-icon">ğŸ”Š</span>
              <span class="volume-value" id="volumeValue">200%</span>
            </div>
            <div style="margin-top:12px;font-size:12px;color:#6b7280;">
              ğŸ’¡ 100% = ì›ë³¸, 200% = 2ë°°, 300% = 3ë°° (ë„ˆë¬´ ë†’ìœ¼ë©´ ìŒì§ˆì´ ì €í•˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
            </div>
          </div>
          
          <button class="video-action-btn" id="btnBoostVolume" onclick="boostVolume()" disabled>
            ğŸ”Š ì†Œë¦¬ í‚¤ìš°ê¸°
          </button>
          
          <div class="video-progress" id="volumeProgress">
            <div class="video-progress-bar">
              <div class="video-progress-fill" id="volumeProgressFill" style="width: 0%"></div>
            </div>
            <div class="video-progress-text" id="volumeProgressText">ì²˜ë¦¬ ì¤‘...</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="ctrl-btn" onclick="closeVideoEditorModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    // ========== ìš´ì˜ì ì¸ì¦ ì •ë³´ ==========
    const ADMIN_CREDENTIALS = [
      { name: 'ìµœì¤€ì¼', employeeId: '19930007' },
      { name: 'ë°•ì„±ì£¼', employeeId: '01056568082' },
      { name: 'ê¹€í–¥ë¯¸', employeeId: '01022363841' },
      { name: 'ì¶”êµí˜„', employeeId: '01076706634' }
    ];

    // í˜„ì¬ ì‚¬ìš©ì ì •ë³´
    let currentUser = {
      role: 'student',  // 'admin', 'professor', 'student' - ê¸°ë³¸ê°’ í•™ìƒ
      name: '',
      course: ''
    };

    // ========== ìˆ˜ì—… ë…¹í™” ê´€ë ¨ ë³€ìˆ˜ ==========
    let mediaRecorder = null;
    let recordedChunks = [];
    let recordingStream = null;
    let currentSession = 1;  // í˜„ì¬ ì°¨ì‹œ
    let sessionCountByWeek = {};  // ì£¼ì°¨ë³„ ì°¨ì‹œ ëˆ„ì  ì¹´ìš´íŠ¸ { ì£¼ì°¨: ì°¨ì‹œ }
    let recordingMimeType = 'video/mp4';  // ë…¹í™” í˜•ì‹
    let recordingExtension = 'avi';  // íŒŒì¼ í™•ì¥ì
    
    // ì£¼ì°¨ë³„ ì°¨ì‹œ ì¹´ìš´íŠ¸ ë¡œë“œ
    function loadSessionCount() {
      const saved = localStorage.getItem('sessionCountByWeek');
      if (saved) {
        sessionCountByWeek = JSON.parse(saved);
      }
    }
    
    // ì£¼ì°¨ë³„ ì°¨ì‹œ ì¹´ìš´íŠ¸ ì €ì¥
    function saveSessionCount() {
      localStorage.setItem('sessionCountByWeek', JSON.stringify(sessionCountByWeek));
    }

    // ê°•ì˜ ë°ì´í„° (ìš´ì˜ìê°€ ê´€ë¦¬)
    let courseData = [];  // { id, name, professor, students: [] }
    let courseDataLoaded = false;  // ë°ì´í„° ë¡œë“œ ì™„ë£Œ ì—¬ë¶€

    // ========== Firebase ì„¤ì • ==========
    const firebaseConfig = {
      apiKey: "AIzaSyBBDEBlBzo2VWDNIJP4-wn5crBkXlum5zM",
      authDomain: "online-fcfe9.firebaseapp.com",
      databaseURL: "https://online-fcfe9-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "online-fcfe9",
      storageBucket: "online-fcfe9.firebasestorage.app",
      messagingSenderId: "484288182734",
      appId: "1:484288182734:web:c26552da2c688cc327d39f",
      measurementId: "G-0D3SF4FMH7"
    };

    // Firebase ì´ˆê¸°í™”
    let db = null;
    let firebaseEnabled = false;

    // Firebase ì—°ê²° ìƒíƒœ ì €ì¥
    let lastFirebaseStatus = { connected: false, message: 'í™•ì¸ ì¤‘...' };
    
    function updateFirebaseStatus(connected, message) {
      lastFirebaseStatus = { connected, message };
      applyFirebaseStatus();
    }
    
    function applyFirebaseStatus() {
      const statusEl = document.getElementById('firebaseStatus');
      if (statusEl) {
        if (lastFirebaseStatus.connected) {
          statusEl.innerHTML = `<span style="color: #10b981;">ğŸŸ¢ í´ë¼ìš°ë“œ ì—°ê²°ë¨</span>`;
        } else {
          statusEl.innerHTML = `<span style="color: #f59e0b;">ğŸŸ¡ ${lastFirebaseStatus.message || 'ë¡œì»¬ ëª¨ë“œ'}</span>`;
        }
      } else {
        // ìš”ì†Œê°€ ì•„ì§ ì—†ìœ¼ë©´ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„
        setTimeout(applyFirebaseStatus, 500);
      }
    }

    try {
      if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        firebaseEnabled = true;  // ì¼ë‹¨ í™œì„±í™”
        
        // Firebaseì—ì„œ ê°•ì˜ ë°ì´í„° ì‹¤ì‹œê°„ ìˆ˜ì‹  ì‹œì‘
        db.ref('courses').on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            courseData = Object.values(data);
          } else {
            courseData = [];
          }
          courseDataLoaded = true;
          console.log('ğŸ“¥ Firebaseì—ì„œ ê°•ì˜ ë°ì´í„° ë¡œë“œ:', courseData.length, 'ê°œ');
          if (courseData.length > 0) {
            console.log('ğŸ“‹ ë“±ë¡ëœ ê°•ì˜:', courseData.map(c => `${c.name}(${c.professor})`).join(', '));
          }
          
          // UI ì—…ë°ì´íŠ¸
          if (document.getElementById('courseModal')?.classList.contains('show')) {
            renderCourseList();
          }
          updateCourseDropdowns();
          updateLoadingStatus();
        });
        
        // ì—°ê²° ìƒíƒœ í™•ì¸
        db.ref('.info/connected').on('value', (snapshot) => {
          if (snapshot.val() === true) {
            updateFirebaseStatus(true);
            console.log('âœ… Firebase ì—°ê²° ì„±ê³µ');
          } else {
            updateFirebaseStatus(false, 'ì—°ê²° ëŠê¹€');
            console.log('âš ï¸ Firebase ì—°ê²° ëŠê¹€');
          }
        });
      } else {
        throw new Error('Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤');
      }
    } catch (error) {
      console.warn('âš ï¸ Firebase ë¯¸ì„¤ì •, ë¡œì»¬ ì €ì¥ì†Œ ì‚¬ìš©:', error.message);
      firebaseEnabled = false;
      setTimeout(() => updateFirebaseStatus(false, 'Firebase ì„¤ì • í•„ìš”'), 100);
      // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë¡œë“œ
      const saved = localStorage.getItem('gcu_courses');
      if (saved) {
        courseData = JSON.parse(saved);
      }
      courseDataLoaded = true;
    }

    // DOM ìš”ì†Œ
    const loginOverlay = document.getElementById('loginOverlay');
    const mainApp = document.getElementById('mainApp');
    const btnAdmin = document.getElementById('btnAdmin');
    const btnProfessor = document.getElementById('btnProfessor');
    const btnStudent = document.getElementById('btnStudent');

    // ë¡œë”© ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateLoadingStatus() {
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn && courseDataLoaded) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸš€ ê°•ì˜ì‹¤ ì…ì¥';
      }
    }
    
    // ê°•ì˜ ë°ì´í„° ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨
    function refreshCourseData() {
      if (firebaseEnabled && db) {
        db.ref('courses').once('value').then((snapshot) => {
          const data = snapshot.val();
          if (data) {
            courseData = Object.values(data);
          } else {
            courseData = [];
          }
          courseDataLoaded = true;
          console.log('ğŸ”„ ê°•ì˜ ë°ì´í„° ìƒˆë¡œê³ ì¹¨:', courseData.length, 'ê°œ');
        });
      }
    }

    // ê°•ì˜ ë°ì´í„° ì €ì¥ (Firebase ë˜ëŠ” localStorage)
    function saveCourseData() {
      if (firebaseEnabled && db) {
        // Firebaseì— ì €ì¥ (ë°°ì—´ì„ ê°ì²´ë¡œ ë³€í™˜)
        const coursesObj = {};
        courseData.forEach(course => {
          coursesObj[course.id] = course;
        });
        db.ref('courses').set(coursesObj)
          .then(() => console.log('ğŸ“¤ Firebaseì— ê°•ì˜ ë°ì´í„° ì €ì¥ ì™„ë£Œ'))
          .catch(err => console.error('Firebase ì €ì¥ ì˜¤ë¥˜:', err));
      } else {
        // ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥
        localStorage.setItem('gcu_courses', JSON.stringify(courseData));
      }
    }

    // ê°•ì˜ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    function updateCourseDropdowns() {
      // ì¶œì„ë¶€ ê°•ì˜ ì„ íƒ ë“œë¡­ë‹¤ìš´
      const attendanceCourseSelect = document.getElementById('attendanceCourseSelect');
      if (attendanceCourseSelect) {
        const currentValue = attendanceCourseSelect.value;
        attendanceCourseSelect.innerHTML = '<option value="all">ì „ì²´ ê°•ì˜</option>' +
          courseData.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        if (currentValue && courseData.find(c => c.name === currentValue)) {
          attendanceCourseSelect.value = currentValue;
        }
      }
    }

    // ì¶œì„ ë°ì´í„° ë¡œë“œ (Firebase ë˜ëŠ” localStorage)
    function loadAttendanceData(courseName) {
      return new Promise((resolve) => {
        const key = `attendance_${courseName}`;
        if (firebaseEnabled && db) {
          db.ref(`attendance/${courseName.replace(/[.#$\/\[\]]/g, '_')}`).once('value')
            .then(snapshot => {
              resolve(snapshot.val() || { weeks: {} });
            })
            .catch(() => resolve({ weeks: {} }));
        } else {
          const saved = localStorage.getItem(key);
          resolve(saved ? JSON.parse(saved) : { weeks: {} });
        }
      });
    }

    // ì¶œì„ ë°ì´í„° ì €ì¥ (Firebase ë˜ëŠ” localStorage)
    function saveAttendanceData(courseName, data) {
      const key = `attendance_${courseName}`;
      if (firebaseEnabled && db) {
        db.ref(`attendance/${courseName.replace(/[.#$\/\[\]]/g, '_')}`).set(data)
          .then(() => console.log('ğŸ“¤ ì¶œì„ ë°ì´í„° ì €ì¥ ì™„ë£Œ'))
          .catch(err => console.error('ì¶œì„ ì €ì¥ ì˜¤ë¥˜:', err));
      } else {
        localStorage.setItem(key, JSON.stringify(data));
      }
    }

    // ì—­í•  ì„ íƒ
    function selectRole(role) {
      currentUser.role = role;

      // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
      btnAdmin.classList.remove('active', 'admin');
      btnProfessor.classList.remove('active');
      btnStudent.classList.remove('active');

      // í¼ ìš”ì†Œ
      const groupEmployeeId = document.getElementById('groupEmployeeId');
      const groupCourse = document.getElementById('groupCourse');
      const labelEmployeeId = document.getElementById('labelEmployeeId');
      const inputEmployeeId = document.getElementById('inputEmployeeId');
      const inputCourse = document.getElementById('inputCourse');
      const submitBtn = document.getElementById('submitBtn');

      if (role === 'admin') {
        btnAdmin.classList.add('active', 'admin');
        groupEmployeeId.classList.remove('hidden');
        groupCourse.classList.add('hidden');
        labelEmployeeId.textContent = 'ì‚¬ë²ˆ *';
        inputEmployeeId.placeholder = 'ì‚¬ë²ˆ ì…ë ¥';
        inputEmployeeId.required = true;
        inputCourse.required = false;
        submitBtn.textContent = 'âš™ï¸ ìš´ì˜ ì‹œì‘';
      } else if (role === 'professor') {
        btnProfessor.classList.add('active');
        groupEmployeeId.classList.add('hidden');
        groupCourse.classList.remove('hidden');
        inputEmployeeId.required = false;
        inputCourse.required = true;
        submitBtn.textContent = 'ğŸ‘¨â€ğŸ« êµìˆ˜ë¡œ ì…ì¥';
      } else {
        btnStudent.classList.add('active');
        groupEmployeeId.classList.add('hidden');
        groupCourse.classList.remove('hidden');
        inputEmployeeId.required = false;
        inputCourse.required = true;
        submitBtn.textContent = 'ğŸ‘¨â€ğŸ“ í•™ìƒìœ¼ë¡œ ì…ì¥';
      }
    }

    // ë¡œê·¸ì¸ ì²˜ë¦¬
    function handleLogin(e) {
      e.preventDefault();

      const name = document.getElementById('inputName').value.trim();
      const employeeId = document.getElementById('inputEmployeeId').value.trim();
      const course = document.getElementById('inputCourse').value.trim();

      // ìš´ì˜ì ë¡œê·¸ì¸
      if (currentUser.role === 'admin') {
        const validAdmin = ADMIN_CREDENTIALS.find(admin => admin.name === name && admin.employeeId === employeeId);
        if (!validAdmin) {
          alert('ìš´ì˜ì ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì´ë¦„ê³¼ ì‚¬ë²ˆ/ì „í™”ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
          return;
        }
        currentUser.name = name;
        currentUser.course = '';
        
        loginOverlay.classList.add('hidden');
        mainApp.classList.add('show');
        updateMainUI();
        return;
      }

      // êµìˆ˜/í•™ìƒ ë¡œê·¸ì¸
      if (!name || !course) {
        alert('ì´ë¦„ê³¼ ê°•ì˜ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ë°ì´í„° ë¡œë“œ í™•ì¸
      if (!courseDataLoaded) {
        alert('ê°•ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ë””ë²„ê·¸: í˜„ì¬ ë“±ë¡ëœ ê°•ì˜ ì¶œë ¥
      console.log('ğŸ” ë¡œê·¸ì¸ ì‹œë„:', { name, course, role: currentUser.role });
      console.log('ğŸ“‹ ë“±ë¡ëœ ê°•ì˜ ëª©ë¡:', courseData);
      
      // ë””ë²„ê·¸: ì—­í•  í™•ì¸ (í™”ë©´ì— ì ì‹œ í‘œì‹œ)
      console.log(`ğŸ‘¤ ì„ íƒëœ ì—­í• : ${currentUser.role === 'professor' ? 'êµìˆ˜' : currentUser.role === 'student' ? 'í•™ìƒ' : 'ìš´ì˜ì'}`);

      // ê°•ì˜ ì¡´ì¬ í™•ì¸
      const courseInfo = courseData.find(c => c.name === course);
      if (!courseInfo) {
        const availableCourses = courseData.map(c => c.name).join(', ') || 'ì—†ìŒ';
        alert(`"${course}" ê°•ì˜ê°€ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n\në“±ë¡ëœ ê°•ì˜: ${availableCourses}\n\nìš´ì˜ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.`);
        return;
      }

      // êµìˆ˜ ê²€ì¦
      if (currentUser.role === 'professor') {
        console.log('ğŸ” êµìˆ˜ ê²€ì¦:', { ì…ë ¥ì´ë¦„: name, ë“±ë¡êµìˆ˜: courseInfo.professor });
        if (courseInfo.professor !== name) {
          alert(`"${course}" ê°•ì˜ì˜ ë‹´ë‹¹êµìˆ˜ê°€ ì•„ë‹™ë‹ˆë‹¤.\n\nì…ë ¥í•œ ì´ë¦„: ${name}\në“±ë¡ëœ ë‹´ë‹¹êµìˆ˜: ${courseInfo.professor}`);
          return;
        }
      }

      // í•™ìƒ ê²€ì¦
      if (currentUser.role === 'student') {
        console.log('ğŸ” í•™ìƒ ê²€ì¦:', { ì…ë ¥ì´ë¦„: name, ìˆ˜ê°•ìƒëª©ë¡: courseInfo.students });
        if (!courseInfo.students || !courseInfo.students.includes(name)) {
          const studentList = courseInfo.students?.join(', ') || 'ì—†ìŒ';
          alert(`"${course}" ê°•ì˜ì˜ ìˆ˜ê°•ìƒ ëª…ë‹¨ì— "${name}"ì´(ê°€) ì—†ìŠµë‹ˆë‹¤.\n\në“±ë¡ëœ ìˆ˜ê°•ìƒ: ${studentList}\n\nìš´ì˜ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.`);
          return;
        }
      }

      console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ:', { name, course, role: currentUser.role });

      currentUser.name = name;
      currentUser.course = course;

      // ë¡œê·¸ì¸ í™”ë©´ ìˆ¨ê¸°ê³  ë©”ì¸ ì•± í‘œì‹œ
      loginOverlay.classList.add('hidden');
      mainApp.classList.add('show');

      // UI ì—…ë°ì´íŠ¸
      updateMainUI();

      // Jitsi ê°•ì˜ì‹¤ ë¡œë“œ (ìš´ì˜ìê°€ ì•„ë‹Œ ê²½ìš°)
      if (currentUser.role !== 'admin') {
        console.log('ğŸš€ Jitsi ë¡œë”© ì‹œì‘, course:', course);
        if (!course || course.trim() === '') {
          alert('ì˜¤ë¥˜: ê°•ì˜ëª…ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!\nì…ë ¥ëœ course: "' + course + '"');
          return;
        }
        loadRoom(course);
      }
    }

    // ë©”ì¸ UI ì—…ë°ì´íŠ¸
    function updateMainUI() {
      const userBadge = document.getElementById('userBadge');
      const badgeIcon = document.getElementById('badgeIcon');
      const badgeText = document.getElementById('badgeText');
      const adminControls = document.getElementById('adminControls');
      const professorHeaderBtns = document.getElementById('professorHeaderBtns');
      const studentHeaderBtns = document.getElementById('studentHeaderBtns');

      // ëª¨ë“  ì»¨íŠ¸ë¡¤ ìˆ¨ê¸°ê¸°
      adminControls.classList.remove('show');
      professorHeaderBtns.classList.remove('show');
      studentHeaderBtns.classList.remove('show');

      if (currentUser.role === 'admin') {
        userBadge.className = 'user-badge admin';
        badgeIcon.textContent = 'âš™ï¸';
        badgeText.textContent = `${currentUser.name} ìš´ì˜ì`;
        adminControls.classList.add('show');
        // ìš´ì˜ìëŠ” Jitsi í”„ë ˆì„ ìˆ¨ê¸°ê¸°
        document.getElementById('jitsiFrame').style.display = 'none';
        document.querySelector('.jitsi-header').innerHTML = '<div style="text-align:center;padding:40px;color:#9ca3af;">ìš´ì˜ì ëª¨ë“œ - ìƒë‹¨ ë©”ë‰´ì—ì„œ ê°•ì˜ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</div>';
      } else if (currentUser.role === 'professor') {
        userBadge.className = 'user-badge professor';
        badgeIcon.textContent = 'ğŸ‘¨â€ğŸ«';
        badgeText.textContent = `${currentUser.name} êµìˆ˜`;
        professorHeaderBtns.classList.add('show');
        document.getElementById('jitsiFrame').style.display = '';
        loadAttendanceDataLocal();
        updateClassUI();
      } else {
        userBadge.className = 'user-badge student';
        badgeIcon.textContent = 'ğŸ‘¨â€ğŸ“';
        badgeText.textContent = `${currentUser.name} í•™ìƒ`;
        studentHeaderBtns.classList.add('show');
        document.getElementById('jitsiFrame').style.display = '';
        checkStudentAttendance();
      }
    }

    // ë¡œê·¸ì•„ì›ƒ
    function handleLogout() {
      const message = currentUser.role === 'admin' ? 'ìš´ì˜ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ê°•ì˜ì‹¤ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?';
      if (confirm(message)) {
        // Jitsi í”„ë ˆì„ ì´ˆê¸°í™”
        document.getElementById('jitsiFrame').src = '';
        document.getElementById('jitsiFrame').style.display = '';

        // í¼ ì´ˆê¸°í™”
        document.getElementById('loginForm').reset();
        selectRole('student');

        // í™”ë©´ ì „í™˜
        mainApp.classList.remove('show');
        loginOverlay.classList.remove('hidden');

        // ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™”
        currentUser = {
          role: 'professor',
          name: '',
          course: ''
        };

        // Jitsi í—¤ë” ë³µì›
        document.querySelector('.jitsi-header').innerHTML = `
          <div>
            í˜„ì¬ ê°•ì˜ëª…: <span class="room-name-display" id="roomNameDisplay">-</span>
            <span id="serverStatus" style="margin-left: 12px; font-size: 12px; color: #60a5fa;"></span>
          </div>
          <div class="small-note" style="color:#fbbf24;">
            ğŸ¤ ë§ˆì´í¬/ì¹´ë©”ë¼ ê¶Œí•œì„ <b style="color:#4ade80;">ë°˜ë“œì‹œ í—ˆìš©</b>í•´ì£¼ì„¸ìš”! (ì£¼ì†Œì°½ ì™¼ìª½ ğŸ”’ í´ë¦­)
          </div>
        `;
      }
    }

    // ========== ê°•ì˜ ê´€ë¦¬ (ìš´ì˜ììš©) ==========
    
    function openCourseModal() {
      document.getElementById('courseModal').classList.add('show');
      renderCourseList();
    }

    function closeCourseModal() {
      document.getElementById('courseModal').classList.remove('show');
    }

    function addCourse() {
      const name = document.getElementById('newCourseName').value.trim();
      const professor = document.getElementById('newProfessorName').value.trim();
      const studentText = document.getElementById('newStudentList').value.trim();

      if (!name || !professor) {
        alert('ê°•ì˜ëª…ê³¼ ë‹´ë‹¹êµìˆ˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ì¤‘ë³µ í™•ì¸
      if (courseData.find(c => c.name === name)) {
        alert('ì´ë¯¸ ë“±ë¡ëœ ê°•ì˜ëª…ì…ë‹ˆë‹¤.');
        return;
      }

      // ìˆ˜ê°•ìƒ íŒŒì‹±
      const students = studentText ? studentText.split('\n').map(s => s.trim()).filter(s => s) : [];

      const newCourse = {
        id: Date.now().toString(),
        name,
        professor,
        students
      };

      courseData.push(newCourse);
      saveCourseData();

      // ì¶œì„ ë°ì´í„°ë„ ì´ˆê¸°í™”
      const attendanceKey = `attendance_${name}`;
      if (!localStorage.getItem(attendanceKey)) {
        localStorage.setItem(attendanceKey, JSON.stringify({
          students: students,
          classStartTime: null,
          classEndTime: null,
          isClassActive: false,
          currentWeek: 1,
          records: {}
        }));
      }

      // í¼ ì´ˆê¸°í™”
      document.getElementById('newCourseName').value = '';
      document.getElementById('newProfessorName').value = '';
      document.getElementById('newStudentList').value = '';

      renderCourseList();
      alert(`"${name}" ê°•ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    function renderCourseList() {
      const container = document.getElementById('courseList');

      if (courseData.length === 0) {
        container.innerHTML = '<div class="no-courses">ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      container.innerHTML = courseData.map(course => `
        <div class="course-card">
          <div class="course-card-header">
            <span class="course-card-title">ğŸ“– ${course.name}</span>
          </div>
          <div class="course-card-info">
            <span>ğŸ‘¨â€ğŸ« ë‹´ë‹¹êµìˆ˜: <strong>${course.professor}</strong></span>
            <span>ğŸ‘¥ ìˆ˜ê°•ìƒ: <strong>${course.students.length}ëª…</strong></span>
          </div>
          <div class="course-card-actions">
            <button class="ctrl-btn" onclick="editCourse('${course.id}')">âœï¸ ìˆ˜ì •</button>
            <button class="ctrl-btn danger" onclick="deleteCourse('${course.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>
        </div>
      `).join('');
    }

    function editCourse(courseId) {
      const course = courseData.find(c => c.id === courseId);
      if (!course) return;

      document.getElementById('editCourseId').value = courseId;
      document.getElementById('editCourseName').value = course.name;
      document.getElementById('editProfessorName').value = course.professor;
      document.getElementById('editStudentList').value = course.students.join('\n');

      document.getElementById('editCourseModal').classList.add('show');
    }

    function closeEditCourseModal() {
      document.getElementById('editCourseModal').classList.remove('show');
    }

    function saveCourseEdit() {
      const courseId = document.getElementById('editCourseId').value;
      const name = document.getElementById('editCourseName').value.trim();
      const professor = document.getElementById('editProfessorName').value.trim();
      const studentText = document.getElementById('editStudentList').value.trim();

      if (!name || !professor) {
        alert('ê°•ì˜ëª…ê³¼ ë‹´ë‹¹êµìˆ˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const courseIndex = courseData.findIndex(c => c.id === courseId);
      if (courseIndex === -1) return;

      const oldName = courseData[courseIndex].name;
      const students = studentText ? studentText.split('\n').map(s => s.trim()).filter(s => s) : [];

      courseData[courseIndex] = {
        ...courseData[courseIndex],
        name,
        professor,
        students
      };

      saveCourseData();

      // ì¶œì„ ë°ì´í„° ì—…ë°ì´íŠ¸
      const attendanceKey = `attendance_${name}`;
      const oldAttendanceKey = `attendance_${oldName}`;
      
      // ê°•ì˜ëª…ì´ ë³€ê²½ëœ ê²½ìš° ì¶œì„ ë°ì´í„° í‚¤ë„ ë³€ê²½
      if (oldName !== name) {
        const oldData = localStorage.getItem(oldAttendanceKey);
        if (oldData) {
          localStorage.setItem(attendanceKey, oldData);
          localStorage.removeItem(oldAttendanceKey);
        }
      }

      // ìˆ˜ê°•ìƒ ëª©ë¡ ì—…ë°ì´íŠ¸
      const attendanceData = localStorage.getItem(attendanceKey);
      if (attendanceData) {
        const data = JSON.parse(attendanceData);
        data.students = students;
        localStorage.setItem(attendanceKey, JSON.stringify(data));
      }

      closeEditCourseModal();
      renderCourseList();
      alert('ê°•ì˜ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function deleteCourse(courseId) {
      const course = courseData.find(c => c.id === courseId);
      if (!course) return;

      if (!confirm(`"${course.name}" ê°•ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì¶œì„ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) return;

      // ì¶œì„ ë°ì´í„° ì‚­ì œ
      localStorage.removeItem(`attendance_${course.name}`);

      courseData = courseData.filter(c => c.id !== courseId);
      saveCourseData();
      renderCourseList();
      alert('ê°•ì˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ========== ê°•ì˜ ê´€ë¦¬ (êµìˆ˜ìš©) ==========
    
    function openProfCourseModal() {
      // í˜„ì¬ êµìˆ˜ì˜ ê°•ì˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const myCourse = courseData.find(c => c.name === currentUser.course && c.professor === currentUser.name);
      
      if (!myCourse) {
        alert('í˜„ì¬ ë‹´ë‹¹í•˜ê³  ê³„ì‹  ê°•ì˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      document.getElementById('profCourseName').textContent = myCourse.name;
      document.getElementById('profCourseProf').textContent = myCourse.professor;
      document.getElementById('profCourseCount').textContent = myCourse.students.length;
      document.getElementById('profStudentList').value = myCourse.students.join('\n');
      
      document.getElementById('profCourseModal').classList.add('show');
    }
    
    function closeProfCourseModal() {
      document.getElementById('profCourseModal').classList.remove('show');
    }
    
    function saveProfCourseEdit() {
      const studentText = document.getElementById('profStudentList').value.trim();
      const students = studentText ? studentText.split('\n').map(s => s.trim()).filter(s => s) : [];
      
      // í˜„ì¬ êµìˆ˜ì˜ ê°•ì˜ ì°¾ê¸°
      const courseIndex = courseData.findIndex(c => c.name === currentUser.course && c.professor === currentUser.name);
      
      if (courseIndex === -1) {
        alert('ê°•ì˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ìˆ˜ê°•ìƒ ëª…ë‹¨ë§Œ ì—…ë°ì´íŠ¸
      courseData[courseIndex].students = students;
      saveCourseData();
      
      // ì¶œì„ ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
      const attendanceKey = `attendance_${currentUser.course}`;
      const attendanceData = localStorage.getItem(attendanceKey);
      if (attendanceData) {
        const data = JSON.parse(attendanceData);
        data.students = students;
        localStorage.setItem(attendanceKey, JSON.stringify(data));
      }
      
      // Firebase ì¶œì„ ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
      if (firebaseEnabled) {
        loadAttendanceData(currentUser.course).then(fbData => {
          if (fbData) {
            fbData.students = students;
            saveAttendanceData(currentUser.course, fbData);
          }
        });
      }
      
      // UI ì—…ë°ì´íŠ¸
      document.getElementById('profCourseCount').textContent = students.length;
      
      alert(`ìˆ˜ê°•ìƒ ëª…ë‹¨ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (${students.length}ëª…)`);
      closeProfCourseModal();
      
      // ì¶œì„ë¶€ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
      loadAttendanceDataLocal();
    }

    function openAllAttendanceModal() {
      document.getElementById('allAttendanceModal').classList.add('show');
      
      // ê°•ì˜ ì„ íƒ ì˜µì…˜ ì—…ë°ì´íŠ¸
      const courseSelect = document.getElementById('allAttendanceCourseSelect');
      courseSelect.innerHTML = '<option value="all">ì „ì²´ ê°•ì˜</option>';
      courseData.forEach(course => {
        courseSelect.innerHTML += `<option value="${course.name}">${course.name}</option>`;
      });
      
      renderAllAttendance();
    }

    function closeAllAttendanceModal() {
      document.getElementById('allAttendanceModal').classList.remove('show');
    }

    function renderAllAttendance() {
      const selectedCourse = document.getElementById('allAttendanceCourseSelect').value;
      const selectedWeek = document.getElementById('allAttendanceWeekSelect').value;
      const container = document.getElementById('allAttendanceContent');

      if (courseData.length === 0) {
        container.innerHTML = '<div class="no-courses">ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const coursesToShow = selectedCourse === 'all' 
        ? courseData 
        : courseData.filter(c => c.name === selectedCourse);

      let html = '';

      coursesToShow.forEach(course => {
        const attendanceKey = `attendance_${course.name}`;
        const savedData = localStorage.getItem(attendanceKey);
        const attendanceInfo = savedData ? JSON.parse(savedData) : null;

        html += `<div class="course-attendance-section">`;
        html += `<div class="course-attendance-header">`;
        html += `<div>
          <div class="course-attendance-title">ğŸ“– ${course.name}</div>
          <div class="course-attendance-meta">ë‹´ë‹¹êµìˆ˜: ${course.professor} | ìˆ˜ê°•ìƒ: ${course.students.length}ëª…</div>
        </div>`;
        html += `</div>`;

        // ì£¼ì°¨ íƒ­ ìƒì„±
        if (selectedWeek === 'all') {
          html += `<div class="week-tabs" id="weekTabs_${course.name.replace(/\s/g, '_')}">`;
          for (let w = 1; w <= 16; w++) {
            const hasData = attendanceInfo && attendanceInfo.records && attendanceInfo.records[w];
            const dataClass = hasData ? 'has-data' : '';
            html += `<button class="week-tab ${dataClass} ${w === 1 ? 'active' : ''}" 
                      onclick="showWeekAttendance('${course.name}', ${w}, this)">${w}ì£¼</button>`;
          }
          html += `</div>`;
        }

        // ì¶œì„ í…Œì´ë¸”
        const weekToShow = selectedWeek === 'all' ? 1 : parseInt(selectedWeek);
        html += renderCourseWeekAttendance(course, attendanceInfo, weekToShow);

        html += `</div>`;
      });

      container.innerHTML = html || '<div class="no-courses">í‘œì‹œí•  ì¶œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    function renderCourseWeekAttendance(course, attendanceInfo, week) {
      const records = attendanceInfo && attendanceInfo.records ? attendanceInfo.records[week] : null;
      const isClassActive = attendanceInfo?.isClassActive && attendanceInfo?.currentWeek == week;
      const classStartTime = attendanceInfo?.classStartTime ? new Date(attendanceInfo.classStartTime) : null;
      const classEndTime = attendanceInfo?.classEndTime ? new Date(attendanceInfo.classEndTime) : null;
      
      let html = `<div class="attendance-table-wrapper" id="attendanceTable_${course.name.replace(/\s/g, '_')}">`;
      html += `<table class="mini-attendance-table">`;
      html += `<thead><tr>
        <th style="width:50px;">ë²ˆí˜¸</th>
        <th>ì´ë¦„</th>
        <th style="width:100px;">ì…ì¥ì‹œê°„</th>
        <th style="width:100px;">í‡´ì¥ì‹œê°„</th>
        <th style="width:100px;">ì¶œì„ë¥ </th>
      </tr></thead>`;
      html += `<tbody>`;

      if (course.students.length === 0) {
        html += `<tr><td colspan="5" style="text-align:center;color:#6b7280;padding:20px;">ë“±ë¡ëœ ìˆ˜ê°•ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      } else {
        let attendingCount = 0, partialCount = 0, absentCount = 0, notCheckedCount = 0;

        course.students.forEach((name, index) => {
          const record = records ? records[name] : { joinTime: null, leaveTime: null, status: 'not-checked' };
          
          // ì‹¤ì‹œê°„ ìƒíƒœ ê³„ì‚°
          const realTimeStatus = calculateRealTimeStatusForCourse(record, isClassActive, classStartTime, classEndTime);
          
          if (realTimeStatus.type === 'attending') attendingCount++;
          else if (realTimeStatus.type === 'partial') partialCount++;
          else if (realTimeStatus.type === 'absent') absentCount++;
          else notCheckedCount++;

          const joinTime = record && record.joinTime ? formatTimeFromString(record.joinTime) : '-';
          const leaveTime = record && record.leaveTime ? formatTimeFromString(record.leaveTime) : (isClassActive && record.joinTime ? 'ìˆ˜ì—…ì¤‘' : '-');

          html += `<tr>
            <td>${index + 1}</td>
            <td>${name}</td>
            <td style="font-size:11px;color:#6b7280;">${joinTime}</td>
            <td style="font-size:11px;color:#6b7280;">${leaveTime}</td>
            <td><span class="attendance-status ${realTimeStatus.type}">${realTimeStatus.label}</span></td>
          </tr>`;
        });

        // ìš”ì•½ í–‰
        const summaryParts = [];
        if (attendingCount > 0) summaryParts.push(`<span class="attendance-status attending">ì¶œì„ì¤‘ ${attendingCount}</span>`);
        if (partialCount > 0) summaryParts.push(`<span class="attendance-status partial">ë¶€ë¶„ì¶œì„ ${partialCount}</span>`);
        if (absentCount > 0) summaryParts.push(`<span class="attendance-status absent">ê²°ì„ ${absentCount}</span>`);
        if (notCheckedCount > 0) summaryParts.push(`<span class="attendance-status not-checked">ë¯¸ì¶œê²° ${notCheckedCount}</span>`);
        
        html += `<tr style="background:#0f172a;">
          <td colspan="5" style="padding:10px;">
            ${summaryParts.join('<span style="margin:0 8px;"></span>')}
          </td>
        </tr>`;
      }

      html += `</tbody></table></div>`;
      return html;
    }
    
    // ê°•ì˜ë³„ ì‹¤ì‹œê°„ ìƒíƒœ ê³„ì‚° (ì „ì²´ ì¶œì„ë¶€ìš©)
    function calculateRealTimeStatusForCourse(record, isClassActive, classStartTime, classEndTime) {
      const now = new Date();
      
      if (!record || !record.joinTime) {
        if (isClassActive) {
          return { type: 'not-checked', label: 'ë¯¸ì¶œê²°' };
        } else if (classEndTime) {
          return { type: 'absent', label: 'ê²°ì„' };
        }
        return { type: 'not-checked', label: 'ë¯¸ì¶œê²°' };
      }
      
      const joinTime = new Date(record.joinTime);
      const leaveTime = record.leaveTime ? new Date(record.leaveTime) : null;
      
      if (isClassActive && classStartTime) {
        if (!leaveTime) {
          return { type: 'attending', label: 'ğŸŸ¢ ì¶œì„ì¤‘' };
        } else {
          const totalClassTime = now - classStartTime;
          const attendedTime = leaveTime - joinTime;
          const percent = Math.round((attendedTime / totalClassTime) * 100);
          return { type: 'partial', label: `${Math.min(percent, 100)}% ì¶œì„` };
        }
      }
      
      if (classEndTime && classStartTime) {
        const totalClassTime = classEndTime - classStartTime;
        const effectiveLeaveTime = leaveTime || classEndTime;
        const effectiveJoinTime = joinTime < classStartTime ? classStartTime : joinTime;
        let attendedTime = effectiveLeaveTime - effectiveJoinTime;
        if (attendedTime < 0) attendedTime = 0;
        
        const percent = record.attendancePercent !== undefined ? record.attendancePercent : Math.round((attendedTime / totalClassTime) * 100);
        
        if (percent >= 100) return { type: 'attending', label: 'âœ… 100% ì¶œì„' };
        if (percent > 0) return { type: 'partial', label: `${percent}% ì¶œì„` };
        return { type: 'absent', label: 'ê²°ì„' };
      }
      
      // ë ˆê±°ì‹œ ìƒíƒœ
      if (record.attendancePercent !== undefined) {
        const percent = record.attendancePercent;
        if (percent >= 100) return { type: 'attending', label: 'âœ… 100% ì¶œì„' };
        if (percent > 0) return { type: 'partial', label: `${percent}% ì¶œì„` };
        return { type: 'absent', label: 'ê²°ì„' };
      }
      
      return { type: 'not-checked', label: 'ë¯¸ì¶œê²°' };
    }

    function showWeekAttendance(courseName, week, btn) {
      // íƒ­ í™œì„±í™”
      const tabContainer = btn.parentElement;
      tabContainer.querySelectorAll('.week-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');

      // í…Œì´ë¸” ì—…ë°ì´íŠ¸
      const course = courseData.find(c => c.name === courseName);
      if (!course) return;

      const attendanceKey = `attendance_${courseName}`;
      const savedData = localStorage.getItem(attendanceKey);
      const attendanceInfo = savedData ? JSON.parse(savedData) : null;

      const tableContainer = document.getElementById(`attendanceTable_${courseName.replace(/\s/g, '_')}`);
      if (tableContainer) {
        tableContainer.outerHTML = renderCourseWeekAttendance(course, attendanceInfo, week);
      }
    }

    function formatTimeFromString(timeStr) {
      if (!timeStr) return '-';
      const date = new Date(timeStr);
      return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function exportAllAttendance() {
      const selectedCourse = document.getElementById('allAttendanceCourseSelect').value;
      const selectedWeek = document.getElementById('allAttendanceWeekSelect').value;

      const coursesToExport = selectedCourse === 'all' 
        ? courseData 
        : courseData.filter(c => c.name === selectedCourse);

      if (coursesToExport.length === 0) {
        alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      let csv = '';

      coursesToExport.forEach(course => {
        const attendanceKey = `attendance_${course.name}`;
        const savedData = localStorage.getItem(attendanceKey);
        const attendanceInfo = savedData ? JSON.parse(savedData) : null;

        const weeksToExport = selectedWeek === 'all' 
          ? Array.from({length: 16}, (_, i) => i + 1)
          : [parseInt(selectedWeek)];

        weeksToExport.forEach(week => {
          const records = attendanceInfo && attendanceInfo.records ? attendanceInfo.records[week] : null;
          
          // ë°ì´í„°ê°€ ìˆëŠ” ì£¼ì°¨ë§Œ ë‚´ë³´ë‚´ê¸°
          if (!records && selectedWeek === 'all') return;

          csv += `\n[${course.name}] ${week}ì£¼ì°¨ - ë‹´ë‹¹êµìˆ˜: ${course.professor}\n`;
          csv += `ë²ˆí˜¸,ì´ë¦„,ì…ì¥ì‹œê°„,í‡´ì¥ì‹œê°„,ì¶œì„ë¥ ,ìƒíƒœ\n`;

          const isClassActive = attendanceInfo?.isClassActive && attendanceInfo?.currentWeek == week;
          const classStartTime = attendanceInfo?.classStartTime ? new Date(attendanceInfo.classStartTime) : null;
          const classEndTime = attendanceInfo?.classEndTime ? new Date(attendanceInfo.classEndTime) : null;

          course.students.forEach((name, index) => {
            const record = records ? records[name] : { joinTime: null, leaveTime: null, status: 'not-checked' };
            const realTimeStatus = calculateRealTimeStatusForCourse(record, isClassActive, classStartTime, classEndTime);
            const joinTime = record && record.joinTime ? formatTimeFromString(record.joinTime) : '-';
            const leaveTime = record && record.leaveTime ? formatTimeFromString(record.leaveTime) : '-';
            const percent = record && record.attendancePercent !== undefined ? record.attendancePercent + '%' : '-';

            csv += `${index + 1},${name},${joinTime},${leaveTime},${percent},${realTimeStatus.label.replace(/[ğŸŸ¢âœ…]/g, '')}\n`;
          });
        });
      });

      if (!csv.trim()) {
        alert('ë‚´ë³´ë‚¼ ì¶œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const filename = selectedCourse === 'all' 
        ? `ì „ì²´ì¶œì„ë¶€_${selectedWeek === 'all' ? 'ì „ì²´ì£¼ì°¨' : selectedWeek + 'ì£¼ì°¨'}.csv`
        : `ì¶œì„ë¶€_${selectedCourse}_${selectedWeek === 'all' ? 'ì „ì²´ì£¼ì°¨' : selectedWeek + 'ì£¼ì°¨'}.csv`;
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    // ì„œë²„ ëª©ë¡
    const JITSI_SERVERS = [
      'https://meet.ffmuc.net',
      'https://meet.jit.si',
      'https://jitsi.riot.im',
      'https://meet.scheible.it'
    ];
    
    let currentServerIndex = 0;
    let connectionTimeout = null;
    let currentRoomName = '';
    let currentDisplayName = '';

    // Jitsi URL ìƒì„±
    function buildJitsiUrl(serverUrl, roomName, displayName) {
      const cleanRoom = roomName.trim().replace(/\s+/g, '-');
      const encodedRoom = encodeURIComponent(cleanRoom);
      const encodedName = encodeURIComponent(displayName);
      return `${serverUrl}/${encodedRoom}#userInfo.displayName="${encodedName}"`;
    }

    // ì„œë²„ ìƒíƒœ í‘œì‹œ
    function updateServerStatus(message, isError = false) {
      const statusEl = document.getElementById('serverStatus');
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.style.color = isError ? '#f87171' : '#60a5fa';
      }
    }

    // ë‹¤ìŒ ì„œë²„ ì‹œë„
    function tryNextServer() {
      currentServerIndex++;
      
      if (currentServerIndex >= JITSI_SERVERS.length) {
        // ëª¨ë“  ì„œë²„ ì‹œë„ ì‹¤íŒ¨
        currentServerIndex = 0;
        updateServerStatus('âŒ ëª¨ë“  ì„œë²„ ì ‘ì† ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', true);
        return;
      }
      
      const nextServer = JITSI_SERVERS[currentServerIndex];
      updateServerStatus(`ğŸ”„ ì„œë²„ ë³€ê²½ ì¤‘... (${currentServerIndex + 1}/${JITSI_SERVERS.length})`);
      
      // ì„œë²„ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
      const serverSelect = document.getElementById('serverSelect');
      if (serverSelect) {
        serverSelect.value = nextServer;
      }
      
      // ìƒˆ ì„œë²„ë¡œ ì ‘ì† ì‹œë„
      setTimeout(() => {
        loadRoomWithServer(nextServer);
      }, 1000);
    }

    // íŠ¹ì • ì„œë²„ë¡œ ê°•ì˜ì‹¤ ë¡œë”©
    function loadRoomWithServer(serverUrl) {
      if (!currentRoomName || currentRoomName.trim() === '') {
        console.error('âŒ ê°•ì˜ëª…ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
        updateServerStatus('âŒ ê°•ì˜ëª…ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', true);
        alert('ì˜¤ë¥˜: ê°•ì˜ëª…ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\ncurrentRoomName: ' + currentRoomName);
        return;
      }
      
      const url = buildJitsiUrl(serverUrl, currentRoomName, currentDisplayName);
      const iframe = document.getElementById('jitsiFrame');
      const loadingEl = document.getElementById('jitsiLoading');
      const debugInfo = document.getElementById('debugInfo');
      
      console.log('ğŸ”— Jitsi ì ‘ì† ì‹œë„');
      console.log('  - URL:', url);
      console.log('  - ê°•ì˜ëª…:', currentRoomName);
      console.log('  - í‘œì‹œì´ë¦„:', currentDisplayName);
      
      // ê¸°ì¡´ íƒ€ì„ì•„ì›ƒ ì·¨ì†Œ
      if (connectionTimeout) {
        clearTimeout(connectionTimeout);
      }
      
      // ë¡œë”© í‘œì‹œ
      if (loadingEl) loadingEl.style.display = 'block';
      if (debugInfo) debugInfo.textContent = `URL: ${url.substring(0, 50)}...`;
      
      updateServerStatus(`ğŸ”— ${serverUrl.replace('https://', '')} ì ‘ì† ì¤‘...`);
      
      // iframe ë¡œë“œ
      console.log('ğŸ“º iframe.src ì„¤ì •:', url);
      iframe.src = url;
      
      // 15ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì •
      connectionTimeout = setTimeout(() => {
        updateServerStatus(`âš ï¸ ${serverUrl.replace('https://', '')} ì‘ë‹µ ì—†ìŒ. ë‹¤ë¥¸ ì„œë²„ ì‹œë„ ì¤‘...`, true);
        tryNextServer();
      }, 15000);
    }

    // iframe ë¡œë“œ ì™„ë£Œ ê°ì§€
    function onJitsiLoaded() {
      const iframe = document.getElementById('jitsiFrame');
      const loadingEl = document.getElementById('jitsiLoading');
      
      // ë¹ˆ srcì´ë©´ ë¬´ì‹œ
      if (!iframe.src || iframe.src === '' || iframe.src === 'about:blank' || iframe.src === window.location.href) {
        console.log('â­ï¸ ë¹ˆ iframe ë¡œë“œ ë¬´ì‹œ');
        return;
      }
      
      console.log('âœ… iframe ë¡œë“œ ì™„ë£Œ:', iframe.src);
      
      // ë¡œë”© ìˆ¨ê¸°ê¸°
      if (loadingEl) loadingEl.style.display = 'none';
      
      if (connectionTimeout) {
        clearTimeout(connectionTimeout);
        connectionTimeout = null;
      }
      const serverUrl = JITSI_SERVERS[currentServerIndex];
      updateServerStatus(`âœ… ${serverUrl.replace('https://', '')} ì—°ê²°ë¨`);
    }

    // ê°•ì˜ì‹¤ ì„œë²„ ì •ë³´ ì €ì¥ (Firebase)
    function saveRoomServer(roomName, serverUrl) {
      if (firebaseEnabled && db) {
        const safeRoomName = roomName.replace(/[.#$\/\[\]]/g, '_');
        db.ref(`activeRooms/${safeRoomName}`).set({
          server: serverUrl,
          professor: currentUser.name,
          startedAt: Date.now()
        }).then(() => {
          console.log('ğŸ“¤ ê°•ì˜ì‹¤ ì„œë²„ ì •ë³´ ì €ì¥:', serverUrl);
        }).catch(err => console.error('ì„œë²„ ì •ë³´ ì €ì¥ ì˜¤ë¥˜:', err));
      }
    }

    // ê°•ì˜ì‹¤ ì„œë²„ ì •ë³´ ì¡°íšŒ (Firebase)
    function getRoomServer(roomName) {
      return new Promise((resolve) => {
        if (firebaseEnabled && db) {
          const safeRoomName = roomName.replace(/[.#$\/\[\]]/g, '_');
          db.ref(`activeRooms/${safeRoomName}`).once('value')
            .then(snapshot => {
              const data = snapshot.val();
              if (data && data.server) {
                resolve(data);
              } else {
                resolve(null);
              }
            })
            .catch(() => resolve(null));
        } else {
          resolve(null);
        }
      });
    }

    // ========== ë§ˆì´í¬/ì¹´ë©”ë¼ ê¶Œí•œ ê°•í™” ìš”ì²­ ==========
    
    // ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ í•¸ë“¤ëŸ¬
    async function testMicrophonePermission() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          },
          video: true
        });
        
        // ë§ˆì´í¬ ë ˆë²¨ í‘œì‹œ
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        const microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);
        analyser.fftSize = 256;
        
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        let maxLevel = 0;
        const checkLevel = setInterval(() => {
          analyser.getByteFrequencyData(dataArray);
          const avg = dataArray.reduce((a, b) => a + b) / bufferLength;
          if (avg > maxLevel) maxLevel = avg;
        }, 100);
        
        setTimeout(() => {
          clearInterval(checkLevel);
          stream.getTracks().forEach(track => track.stop());
          audioContext.close();
          
          if (maxLevel > 10) {
            alert(`âœ… ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì„±ê³µ!\n\në§ˆì´í¬ ë ˆë²¨: ${Math.round(maxLevel)}%\në§ˆì´í¬ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ê³  ìˆìŠµë‹ˆë‹¤.`);
          } else {
            alert(`âš ï¸ ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ê²°ê³¼\n\në§ˆì´í¬ ê¶Œí•œì€ í—ˆìš©ë˜ì—ˆì§€ë§Œ ì†Œë¦¬ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\në§ˆì´í¬ì— ëŒ€ê³  ë§í•´ë³´ì‹œê±°ë‚˜ ë§ˆì´í¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`);
          }
        }, 3000);
        
        alert('ğŸ¤ ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì¤‘...\n\n3ì´ˆ ë™ì•ˆ ë§ˆì´í¬ì— ëŒ€ê³  ë§í•´ì£¼ì„¸ìš”!');
        
      } catch (error) {
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
          alert(
            'âŒ ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n' +
            'í•´ê²° ë°©ë²•:\n' +
            '1. ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ì™¼ìª½ì˜ ğŸ”’ ë˜ëŠ” â“˜ ì•„ì´ì½˜ í´ë¦­\n' +
            '2. "ì¹´ë©”ë¼"ì™€ "ë§ˆì´í¬"ë¥¼ "í—ˆìš©"ìœ¼ë¡œ ë³€ê²½\n' +
            '3. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (F5)\n\n' +
            'Chrome ì„¤ì • â†’ ê°œì¸ì •ë³´ ë° ë³´ì•ˆ â†’ ì‚¬ì´íŠ¸ ì„¤ì • ì—ì„œë„ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤.'
          );
        } else if (error.name === 'NotFoundError') {
          alert('âŒ ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\n\në§ˆì´í¬ê°€ ì»´í“¨í„°ì— ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
        } else {
          alert(`âŒ ë§ˆì´í¬ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`);
        }
      }
    }
    
    async function requestMediaPermissions() {
      const loadingEl = document.getElementById('jitsiLoading');
      const debugInfo = document.getElementById('debugInfo');
      
      // ë¡œë”© í‘œì‹œ
      if (loadingEl) {
        loadingEl.style.display = 'block';
      }
      if (debugInfo) {
        debugInfo.textContent = 'ğŸ¤ ë§ˆì´í¬/ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
      }
      updateServerStatus('ğŸ¤ ë§ˆì´í¬ ê¶Œí•œ í™•ì¸ ì¤‘...');
      
      try {
        // ë§ˆì´í¬ì™€ ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ (Chrome ìŠ¤íƒ€ì¼ì˜ ê°•ì œ ìš”ì²­)
        console.log('ğŸ¤ ë¯¸ë””ì–´ ê¶Œí•œ ìš”ì²­ ì‹œì‘...');
        
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          },
          video: true
        });
        
        console.log('âœ… ë¯¸ë””ì–´ ê¶Œí•œ íšë“ ì„±ê³µ');
        
        // ê¶Œí•œì„ ì–»ì€ í›„ ìŠ¤íŠ¸ë¦¼ í•´ì œ (Jitsiê°€ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡)
        stream.getTracks().forEach(track => {
          track.stop();
          console.log(`  - ${track.kind} íŠ¸ë™ í•´ì œ`);
        });
        
        updateServerStatus('âœ… ë§ˆì´í¬/ì¹´ë©”ë¼ ê¶Œí•œ í™•ë³´ ì™„ë£Œ');
        return true;
        
      } catch (error) {
        console.warn('âš ï¸ ë¯¸ë””ì–´ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:', error.name, error.message);
        
        // ê¶Œí•œ ê±°ë¶€ëœ ê²½ìš°
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
          updateServerStatus('âš ï¸ ë§ˆì´í¬/ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë¨', true);
          
          const retry = confirm(
            'ğŸ¤ ë§ˆì´í¬/ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤!\n\n' +
            'ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ì™¼ìª½ì˜ ğŸ”’ ë˜ëŠ” â“˜ ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬\n' +
            'ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ ê¶Œí•œì„ "í—ˆìš©"ìœ¼ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.\n\n' +
            'ì„¤ì • ë³€ê²½ í›„ í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.'
          );
          
          if (retry) {
            // ì¬ì‹œë„
            return await requestMediaPermissions();
          }
          return false;
        }
        
        // ê¸°ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°
        if (error.name === 'NotFoundError') {
          updateServerStatus('âš ï¸ ë§ˆì´í¬/ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
          alert('ğŸ¤ ë§ˆì´í¬ ë˜ëŠ” ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê¸°ê¸°ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
          return false;
        }
        
        // ê¸°íƒ€ ì˜¤ë¥˜
        updateServerStatus('âš ï¸ ë¯¸ë””ì–´ ì˜¤ë¥˜ - ê³„ì† ì§„í–‰...');
        console.log('  - ì˜¤ë¥˜ê°€ ìˆì§€ë§Œ Jitsi ë¡œë”© ê³„ì† ì§„í–‰');
        return true; // ì˜¤ë¥˜ê°€ ìˆì–´ë„ Jitsi ë¡œë”© ì‹œë„
      }
    }
    
    // ê°•ì˜ì‹¤ ë¡œë”©
    async function loadRoom(roomName) {
      console.log('ğŸ“ loadRoom í˜¸ì¶œë¨:', roomName);
      
      if (!roomName || roomName.trim() === '') {
        console.error('âŒ loadRoom: ê°•ì˜ëª…ì´ ë¹„ì–´ìˆìŒ');
        alert('ê°•ì˜ëª…ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ë§ˆì´í¬/ì¹´ë©”ë¼ ê¶Œí•œ ë¨¼ì € ìš”ì²­
      const hasPermission = await requestMediaPermissions();
      if (!hasPermission) {
        console.log('âŒ ë¯¸ë””ì–´ ê¶Œí•œ ì—†ìŒ - ê°•ì˜ì‹¤ ë¡œë”© ì¤‘ë‹¨');
        document.getElementById('jitsiLoading').style.display = 'none';
        return;
      }
      
      // êµìˆ˜: [êµìˆ˜] ì„±ëª…, í•™ìƒ: [í•™ìƒ] ì„±ëª…
      currentDisplayName = currentUser.role === 'professor' 
        ? `[êµìˆ˜] ${currentUser.name}` 
        : `[í•™ìƒ] ${currentUser.name}`;
      
      currentRoomName = roomName;
      document.getElementById('roomNameDisplay').textContent = roomName;
      console.log('ğŸ“‹ roomNameDisplay ì—…ë°ì´íŠ¸:', roomName);
      
      // ì„ íƒëœ ì„œë²„
      const serverSelect = document.getElementById('serverSelect');
      let selectedServer = serverSelect ? serverSelect.value : JITSI_SERVERS[0];
      
      if (currentUser.role === 'professor') {
        // êµìˆ˜: ì„ íƒí•œ ì„œë²„ë¡œ ì ‘ì†í•˜ê³  Firebaseì— ì €ì¥
        currentServerIndex = JITSI_SERVERS.indexOf(selectedServer);
        if (currentServerIndex === -1) currentServerIndex = 0;
        
        saveRoomServer(roomName, JITSI_SERVERS[currentServerIndex]);
        loadRoomWithServer(JITSI_SERVERS[currentServerIndex]);
        
      } else {
        // í•™ìƒ: Firebaseì—ì„œ êµìˆ˜ê°€ ì‚¬ìš© ì¤‘ì¸ ì„œë²„ í™•ì¸
        updateServerStatus('ğŸ” êµìˆ˜ë‹˜ ì„œë²„ í™•ì¸ ì¤‘...');
        
        const roomInfo = await getRoomServer(roomName);
        
        if (roomInfo && roomInfo.server) {
          // êµìˆ˜ê°€ ì‚¬ìš© ì¤‘ì¸ ì„œë²„ë¡œ ìë™ ì—°ê²°
          selectedServer = roomInfo.server;
          currentServerIndex = JITSI_SERVERS.indexOf(selectedServer);
          if (currentServerIndex === -1) currentServerIndex = 0;
          
          // ì„œë²„ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
          if (serverSelect) {
            serverSelect.value = selectedServer;
          }
          
          updateServerStatus(`ğŸ‘¨â€ğŸ« ${roomInfo.professor} êµìˆ˜ë‹˜ ì„œë²„ë¡œ ì—°ê²° ì¤‘...`);
          console.log(`ğŸ“¥ êµìˆ˜ë‹˜ ì„œë²„ í™•ì¸: ${selectedServer}`);
          
          loadRoomWithServer(selectedServer);
        } else {
          // êµìˆ˜ ì •ë³´ ì—†ìœ¼ë©´ ì„ íƒí•œ ì„œë²„ë¡œ ì ‘ì†
          currentServerIndex = JITSI_SERVERS.indexOf(selectedServer);
          if (currentServerIndex === -1) currentServerIndex = 0;
          
          updateServerStatus('âš ï¸ êµìˆ˜ë‹˜ì´ ì•„ì§ ì ‘ì†í•˜ì§€ ì•ŠìŒ. ì„ íƒí•œ ì„œë²„ë¡œ ì—°ê²°...');
          loadRoomWithServer(JITSI_SERVERS[currentServerIndex]);
        }
      }
    }

    // ë””ë²„ê·¸: ìˆ˜ë™ Jitsi í…ŒìŠ¤íŠ¸ (ì½˜ì†”ì—ì„œ testJitsi() ì‹¤í–‰)
    window.testJitsi = function() {
      const testRoom = prompt('í…ŒìŠ¤íŠ¸í•  ê°•ì˜ëª…:', 'í…ŒìŠ¤íŠ¸ê°•ì˜ì‹¤');
      if (testRoom) {
        currentRoomName = testRoom;
        currentDisplayName = '[í…ŒìŠ¤íŠ¸] ì‚¬ìš©ì';
        document.getElementById('roomNameDisplay').textContent = testRoom;
        loadRoomWithServer(JITSI_SERVERS[0]);
        console.log('ğŸ§ª í…ŒìŠ¤íŠ¸ Jitsi ë¡œë”©:', testRoom);
      }
    };

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', () => {
      selectRole('student');
      // Firebase ìƒíƒœ í‘œì‹œ ì ìš©
      applyFirebaseStatus();
    });

    // ========== ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ ==========
    
    // ì¶œì„ ë°ì´í„° êµ¬ì¡°
    let attendanceData = {
      students: [],        // ìˆ˜ê°•ìƒ ëª©ë¡
      classStartTime: null, // ìˆ˜ì—… ì‹œì‘ ì‹œê°„
      classEndTime: null,   // ìˆ˜ì—… ì¢…ë£Œ ì‹œê°„
      isClassActive: false, // ìˆ˜ì—… ì§„í–‰ ì¤‘ ì—¬ë¶€
      currentWeek: 1,       // í˜„ì¬ ì£¼ì°¨
      records: {}           // ì£¼ì°¨ë³„ ì¶œì„ ê¸°ë¡ { week: { studentName: { joinTime, leaveTime, status } } }
    };

    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í‚¤ ìƒì„± (ê°•ì˜ëª… ê¸°ë°˜)
    function getStorageKey() {
      return `attendance_${currentUser.course}`;
    }

    function getFirebaseAttendanceKey() {
      return currentUser.course.replace(/[.#$\/\[\]]/g, '_');
    }

    // ë°ì´í„° ì €ì¥ (Firebase ë˜ëŠ” localStorage)
    function saveAttendanceDataLocal() {
      const dataToSave = {
        ...attendanceData,
        classStartTime: attendanceData.classStartTime ? attendanceData.classStartTime.toISOString() : null,
        classEndTime: attendanceData.classEndTime ? attendanceData.classEndTime.toISOString() : null
      };
      
      if (firebaseEnabled && db) {
        db.ref(`attendance/${getFirebaseAttendanceKey()}`).set(dataToSave)
          .then(() => console.log('ğŸ“¤ ì¶œì„ ë°ì´í„° Firebase ì €ì¥ ì™„ë£Œ'))
          .catch(err => console.error('ì¶œì„ ì €ì¥ ì˜¤ë¥˜:', err));
      }
      // ë¡œì»¬ì—ë„ ì €ì¥ (ë°±ì—…)
      localStorage.setItem(getStorageKey(), JSON.stringify(dataToSave));
    }

    // ë°ì´í„° ë¡œë“œ (Firebase ë˜ëŠ” localStorage)
    function loadAttendanceDataLocal() {
      if (firebaseEnabled && db) {
        db.ref(`attendance/${getFirebaseAttendanceKey()}`).once('value')
          .then(snapshot => {
            const data = snapshot.val();
            if (data) {
              attendanceData = data;
              // ë‚ ì§œ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜
              if (attendanceData.classStartTime) {
                attendanceData.classStartTime = new Date(attendanceData.classStartTime);
              }
              if (attendanceData.classEndTime) {
                attendanceData.classEndTime = new Date(attendanceData.classEndTime);
              }
              console.log('ğŸ“¥ ì¶œì„ ë°ì´í„° Firebaseì—ì„œ ë¡œë“œ');
            } else {
              // Firebaseì— ë°ì´í„° ì—†ìœ¼ë©´ ë¡œì»¬ì—ì„œ ë¡œë“œ
              loadFromLocalStorage();
            }
            syncStudentsFromCourseData();
          })
          .catch(err => {
            console.error('Firebase ë¡œë“œ ì˜¤ë¥˜:', err);
            loadFromLocalStorage();
            syncStudentsFromCourseData();
          });
      } else {
        loadFromLocalStorage();
        syncStudentsFromCourseData();
      }
    }
    
    function loadFromLocalStorage() {
      const saved = localStorage.getItem(getStorageKey());
      if (saved) {
        attendanceData = JSON.parse(saved);
        // ë‚ ì§œ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜
        if (attendanceData.classStartTime) {
          attendanceData.classStartTime = new Date(attendanceData.classStartTime);
        }
        if (attendanceData.classEndTime) {
          attendanceData.classEndTime = new Date(attendanceData.classEndTime);
        }
      }
    }
    
    function syncStudentsFromCourseData() {
      // courseDataì—ì„œ ìˆ˜ê°•ìƒ ëª©ë¡ ë™ê¸°í™”
      const courseInfo = courseData.find(c => c.name === currentUser.course);
      if (courseInfo) {
        attendanceData.students = courseInfo.students || [];
        saveAttendanceDataLocal();
      }
    }

    // ========== ìˆ˜ê°•ìƒ ê´€ë¦¬ ==========
    
    function openStudentModal() {
      document.getElementById('studentModal').classList.add('show');
      renderStudentList();
    }

    function closeStudentModal() {
      document.getElementById('studentModal').classList.remove('show');
    }

    function handleStudentKeypress(e) {
      if (e.key === 'Enter') {
        addStudent();
      }
    }

    function addStudent() {
      const input = document.getElementById('newStudentName');
      const name = input.value.trim();
      
      if (!name) {
        alert('ìˆ˜ê°•ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (attendanceData.students.includes(name)) {
        alert('ì´ë¯¸ ë“±ë¡ëœ ìˆ˜ê°•ìƒì…ë‹ˆë‹¤.');
        return;
      }
      
      attendanceData.students.push(name);
      saveAttendanceDataLocal();
      renderStudentList();
      input.value = '';
      input.focus();
    }

    function removeStudent(name) {
      if (confirm(`"${name}" ìˆ˜ê°•ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        attendanceData.students = attendanceData.students.filter(s => s !== name);
        saveAttendanceDataLocal();
        renderStudentList();
      }
    }

    function renderStudentList() {
      const container = document.getElementById('studentList');
      
      if (attendanceData.students.length === 0) {
        container.innerHTML = '<div class="empty-list">ë“±ë¡ëœ ìˆ˜ê°•ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      container.innerHTML = attendanceData.students.map((name, index) => `
        <div class="student-item">
          <span class="student-name">${index + 1}. ${name}</span>
          <button class="delete-btn" onclick="removeStudent('${name}')">&times;</button>
        </div>
      `).join('');
    }

    // ========== ìˆ˜ì—… ë…¹í™” ê¸°ëŠ¥ ==========
    
    async function startRecording() {
      try {
        // í™”ë©´ + ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ìš”ì²­
        const displayStream = await navigator.mediaDevices.getDisplayMedia({
          video: {
            displaySurface: 'browser',
            width: { ideal: 1920 },
            height: { ideal: 1080 },
            frameRate: { ideal: 30 }
          },
          audio: true
        });

        // ë§ˆì´í¬ ì˜¤ë””ì˜¤ ì¶”ê°€ ì‹œë„
        let combinedStream = displayStream;
        try {
          const audioStream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: true
            }
          });
          
          // ìŠ¤íŠ¸ë¦¼ í•©ì„±
          const audioTracks = [
            ...displayStream.getAudioTracks(),
            ...audioStream.getAudioTracks()
          ];
          const videoTracks = displayStream.getVideoTracks();
          
          combinedStream = new MediaStream([...videoTracks, ...audioTracks]);
        } catch (audioErr) {
          console.log('ë§ˆì´í¬ ì ‘ê·¼ ì‹¤íŒ¨, í™”ë©´ ì˜¤ë””ì˜¤ë§Œ ë…¹í™”:', audioErr);
        }

        recordingStream = combinedStream;
        recordedChunks = [];

        // MediaRecorder ìƒì„± (MP4 ìš°ì„ , ë¯¸ì§€ì› ì‹œ WebM í´ë°±)
        let options = { mimeType: 'video/mp4;codecs=avc1,mp4a.40.2' };
        
        // ì½”ë± ì„ íƒ (MP4 ìš°ì„ , WebM í´ë°±) - í™•ì¥ìëŠ” .mpegìœ¼ë¡œ í†µì¼
        if (MediaRecorder.isTypeSupported(options.mimeType)) {
          recordingMimeType = 'video/mp4';
        } else if (MediaRecorder.isTypeSupported('video/mp4')) {
          options.mimeType = 'video/mp4';
          recordingMimeType = 'video/mp4';
        } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus')) {
          options.mimeType = 'video/webm;codecs=vp9,opus';
          recordingMimeType = 'video/webm';
        } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8,opus')) {
          options.mimeType = 'video/webm;codecs=vp8,opus';
          recordingMimeType = 'video/webm';
        } else {
          options.mimeType = 'video/webm';
          recordingMimeType = 'video/webm';
        }
        recordingExtension = 'avi';  // í™•ì¥ìëŠ” í•­ìƒ .avi
        
        console.log('ğŸ¥ ë…¹í™” í˜•ì‹:', options.mimeType);

        mediaRecorder = new MediaRecorder(combinedStream, options);
        
        mediaRecorder.ondataavailable = (event) => {
          if (event.data && event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = async () => {
          console.log('ğŸ¥ mediaRecorder.onstop ì´ë²¤íŠ¸ ë°œìƒ');
          try {
            await saveRecording();
          } catch (err) {
            console.error('ğŸ¥ saveRecording ì˜¤ë¥˜:', err);
            alert('ë…¹í™” ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
          }
        };

        // í™”ë©´ ê³µìœ  ì¢…ë£Œ ì‹œ ë…¹í™”ë„ ì¤‘ì§€
        displayStream.getVideoTracks()[0].onended = () => {
          if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            stopRecording();
          }
        };

        mediaRecorder.start(1000); // 1ì´ˆë§ˆë‹¤ ë°ì´í„° ìˆ˜ì§‘
        
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('recordingIndicator').style.display = 'inline-flex';
        document.getElementById('btnStopRecording').style.display = 'inline-block';
        document.getElementById('chkRecordClass').disabled = true;
        
        console.log('ğŸ¥ ìˆ˜ì—… ë…¹í™” ì‹œì‘');
        return true;
      } catch (err) {
        console.error('ë…¹í™” ì‹œì‘ ì‹¤íŒ¨:', err);
        alert('í™”ë©´ ë…¹í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní™”ë©´ ê³µìœ ë¥¼ í—ˆìš©í•´ì£¼ì„¸ìš”.');
        return false;
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        console.log('ğŸ¥ ìˆ˜ì—… ë…¹í™” ì¢…ë£Œ');
      }
      
      // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
      if (recordingStream) {
        recordingStream.getTracks().forEach(track => track.stop());
        recordingStream = null;
      }
      
      // UI ì—…ë°ì´íŠ¸
      document.getElementById('recordingIndicator').style.display = 'none';
      document.getElementById('btnStopRecording').style.display = 'none';
      document.getElementById('chkRecordClass').disabled = false;
    }

    // ìˆ˜ë™ ë…¹í™” ì¢…ë£Œ (ë²„íŠ¼ í´ë¦­)
    function stopRecordingManual() {
      if (!confirm('ë…¹í™”ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë…¹í™” íŒŒì¼ì´ ì €ì¥ë©ë‹ˆë‹¤)')) return;
      stopRecording();
    }

    async function saveRecording() {
      console.log('ğŸ¥ saveRecording í˜¸ì¶œë¨, chunks:', recordedChunks.length);
      
      if (recordedChunks.length === 0) {
        console.log('ì €ì¥í•  ë…¹í™” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        alert('ì €ì¥í•  ë…¹í™” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\në…¹í™”ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }

      const blob = new Blob(recordedChunks, { type: recordingMimeType });
      console.log('ğŸ¥ Blob ìƒì„±ë¨, í¬ê¸°:', blob.size, 'bytes, í˜•ì‹:', recordingMimeType);
      
      // íŒŒì¼ëª… ìƒì„±: ì£¼ì°¨ìˆ˜-ì°¨ì‹œìˆ˜. ê°•ì˜ëª… ì£¼ì°¨ìˆ˜ì£¼ì°¨ ì°¨ì‹œìˆ˜ì°¨ì‹œ.í™•ì¥ì
      const courseName = currentUser?.course || 'ìˆ˜ì—…';
      const week = attendanceData.currentWeek || 1;
      const session = currentSession || 1;
      const fileName = `${week}-${session}. ${courseName} ${week}ì£¼ì°¨ ${session}ì°¨ì‹œ.${recordingExtension}`;
      
      console.log('ğŸ¥ ì €ì¥í•  íŒŒì¼ëª…:', fileName);

      let saved = false;

      // File System Access API ì§€ì› ì—¬ë¶€ í™•ì¸ (ì €ì¥ ìœ„ì¹˜ ì„ íƒ ê°€ëŠ¥)
      if ('showSaveFilePicker' in window) {
        try {
          const fileTypes = [{ description: 'AVI ë¹„ë””ì˜¤ íŒŒì¼', accept: { 'video/x-msvideo': ['.avi'] } }];
          
          const fileHandle = await window.showSaveFilePicker({
            suggestedName: fileName,
            types: fileTypes
          });
          
          const writable = await fileHandle.createWritable();
          await writable.write(blob);
          await writable.close();
          
          saved = true;
          recordedChunks = [];
          console.log('ğŸ¥ ë…¹í™” íŒŒì¼ ì €ì¥ ì™„ë£Œ (ìœ„ì¹˜ ì„ íƒ):', fileHandle.name);
          alert(`ìˆ˜ì—… ë…¹í™”ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\níŒŒì¼ëª…: ${fileHandle.name}`);
        } catch (err) {
          console.log('íŒŒì¼ ì €ì¥ ì˜¤ë¥˜ ë˜ëŠ” ì·¨ì†Œ:', err.name, err.message);
          // ì·¨ì†Œí•˜ê±°ë‚˜ ì˜¤ë¥˜ ì‹œ í´ë°±ìœ¼ë¡œ ì§„í–‰
        }
      }
      
      // í´ë°±: ê¸°ì¡´ ë‹¤ìš´ë¡œë“œ ë°©ì‹
      if (!saved) {
        console.log('ğŸ¥ í´ë°± ë‹¤ìš´ë¡œë“œ ë°©ì‹ ì‚¬ìš©');
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        // ì•½ê°„ì˜ ì§€ì—° í›„ ì •ë¦¬
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 1000);
        
        recordedChunks = [];
        console.log('ğŸ¥ ë…¹í™” íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', fileName);
        alert(`ìˆ˜ì—… ë…¹í™”ê°€ ë‹¤ìš´ë¡œë“œ í´ë”ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\níŒŒì¼ëª…: ${fileName}`);
      }
    }

    // ========== ìˆ˜ì—… ì‹œì‘/ì¢…ë£Œ ==========
    
    async function startClass() {
      if (attendanceData.students.length === 0) {
        alert('ìˆ˜ê°•ìƒì´ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\nìš´ì˜ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì£¼ì°¨ë³„ ì°¨ì‹œ ì¹´ìš´íŠ¸ ë¡œë“œ
      loadSessionCount();
      
      const week = prompt('ëª‡ ì£¼ì°¨ ìˆ˜ì—…ì¸ê°€ìš”? (1-16)', attendanceData.currentWeek);
      if (!week) return;
      
      const weekNum = parseInt(week);
      if (isNaN(weekNum) || weekNum < 1 || weekNum > 16) {
        alert('1-16 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì°¨ì‹œ ìë™ ëˆ„ì  (í•´ë‹¹ ì£¼ì°¨ì˜ ì´ì „ ì°¨ì‹œ + 1)
      if (!sessionCountByWeek[weekNum]) {
        sessionCountByWeek[weekNum] = 0;
      }
      sessionCountByWeek[weekNum]++;
      currentSession = sessionCountByWeek[weekNum];
      
      // ì°¨ì‹œ ì¹´ìš´íŠ¸ ì €ì¥
      saveSessionCount();
      
      // ë…¹í™” ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ ë…¹í™” ì‹œì‘
      const shouldRecord = document.getElementById('chkRecordClass')?.checked;
      if (shouldRecord) {
        const recordingStarted = await startRecording();
        if (!recordingStarted) {
          // ë…¹í™” ì‹œì‘ ì‹¤íŒ¨ ì‹œ ìˆ˜ì—… ì‹œì‘ ì—¬ë¶€ í™•ì¸
          if (!confirm('í™”ë©´ ë…¹í™”ë¥¼ ì‹œì‘í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\në…¹í™” ì—†ì´ ìˆ˜ì—…ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
          }
        }
      }
      
      attendanceData.currentWeek = weekNum;
      attendanceData.classStartTime = new Date();
      attendanceData.classEndTime = null;
      attendanceData.isClassActive = true;
      
      // í•´ë‹¹ ì£¼ì°¨ ì¶œì„ ê¸°ë¡ ì´ˆê¸°í™”
      if (!attendanceData.records[weekNum]) {
        attendanceData.records[weekNum] = {};
      }
      
      // ëª¨ë“  í•™ìƒ ê²°ì„ìœ¼ë¡œ ì´ˆê¸°í™”
      attendanceData.students.forEach(name => {
        if (!attendanceData.records[weekNum][name]) {
          attendanceData.records[weekNum][name] = {
            joinTime: null,
            leaveTime: null,
            status: 'absent'
          };
        }
      });
      
      saveAttendanceDataLocal();
      updateClassUI();
      
      const recordingMsg = mediaRecorder && mediaRecorder.state === 'recording' ? '\nğŸ¥ ìˆ˜ì—… ë…¹í™” ì¤‘' : '';
      alert(`${weekNum}ì£¼ì°¨ ${currentSession}ì°¨ì‹œ ìˆ˜ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!\nì‹œì‘ ì‹œê°„: ${formatTime(attendanceData.classStartTime)}${recordingMsg}`);
    }

    function endClass() {
      const isRecording = mediaRecorder && mediaRecorder.state === 'recording';
      const confirmMsg = isRecording 
        ? 'ìˆ˜ì—…ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë…¹í™” íŒŒì¼ì´ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤)' 
        : 'ìˆ˜ì—…ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
      
      if (!confirm(confirmMsg)) return;
      
      // ë…¹í™” ì¤‘ì´ë©´ ë…¹í™” ì¢…ë£Œ
      if (isRecording) {
        stopRecording();
      }
      
      attendanceData.classEndTime = new Date();
      attendanceData.isClassActive = false;
      
      // ì¶œì„ ìƒíƒœ ìµœì¢… ê³„ì‚°
      calculateFinalAttendance();
      
      saveAttendanceDataLocal();
      updateClassUI();
      
      // ì¶œì„ ê²°ê³¼ í‘œì‹œ
      openAttendanceModal();
      alert(`ìˆ˜ì—…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nì¢…ë£Œ ì‹œê°„: ${formatTime(attendanceData.classEndTime)}`);
    }

    function calculateFinalAttendance() {
      const week = attendanceData.currentWeek;
      if (!attendanceData.records[week]) {
        attendanceData.records[week] = {};
      }
      const records = attendanceData.records[week];
      const startTime = new Date(attendanceData.classStartTime);
      const endTime = new Date(attendanceData.classEndTime);
      const totalClassTime = endTime - startTime;
      
      attendanceData.students.forEach(name => {
        if (!records[name]) {
          // ê¸°ë¡ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
          records[name] = { joinTime: null, leaveTime: null, status: 'not-checked' };
        }
        
        const record = records[name];
        
        if (!record.joinTime) {
          // ì…ì¥ ê¸°ë¡ ì—†ìŒ = ê²°ì„
          record.status = 'absent';
          record.attendancePercent = 0;
        } else {
          const joinTime = new Date(record.joinTime);
          const leaveTime = record.leaveTime ? new Date(record.leaveTime) : endTime;
          
          // ìœ íš¨ ì…ì¥ ì‹œê°„ (ìˆ˜ì—… ì‹œì‘ ì „ì— ë“¤ì–´ì™”ìœ¼ë©´ ìˆ˜ì—… ì‹œì‘ ì‹œê°„ìœ¼ë¡œ)
          const effectiveJoinTime = joinTime < startTime ? startTime : joinTime;
          // ìœ íš¨ í‡´ì¥ ì‹œê°„ (ìˆ˜ì—… ì¢…ë£Œ í›„ì— ë‚˜ê°”ìœ¼ë©´ ìˆ˜ì—… ì¢…ë£Œ ì‹œê°„ìœ¼ë¡œ)
          const effectiveLeaveTime = leaveTime > endTime ? endTime : leaveTime;
          
          // ì°¸ì„ ì‹œê°„ ê³„ì‚°
          let attendedTime = effectiveLeaveTime - effectiveJoinTime;
          if (attendedTime < 0) attendedTime = 0;
          
          // ì¶œì„ë¥  ê³„ì‚°
          const percent = Math.round((attendedTime / totalClassTime) * 100);
          record.attendancePercent = Math.min(percent, 100);
          
          // ìƒíƒœ ê²°ì • (í¼ì„¼íŠ¸ ê¸°ë°˜)
          if (percent >= 100) {
            record.status = 'present';
          } else if (percent >= 80) {
            record.status = 'late'; // 80% ì´ìƒì´ë©´ ì§€ê° ì²˜ë¦¬
          } else if (percent > 0) {
            record.status = 'early-leave'; // 80% ë¯¸ë§Œì´ë©´ ì¡°í‡´
          } else {
            record.status = 'absent';
          }
        }
      });
      
      saveAttendanceDataLocal();
    }

    function updateClassUI() {
      const btnStart = document.getElementById('btnStartClass');
      const btnEnd = document.getElementById('btnEndClass');
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('classStatusText');
      
      if (attendanceData.isClassActive) {
        btnStart.disabled = true;
        btnEnd.disabled = false;
        statusDot.classList.add('live');
        statusText.textContent = `${attendanceData.currentWeek}ì£¼ì°¨ ìˆ˜ì—… ì§„í–‰ì¤‘`;
      } else {
        btnStart.disabled = false;
        btnEnd.disabled = true;
        statusDot.classList.remove('live');
        statusText.textContent = 'ìˆ˜ì—… ëŒ€ê¸°ì¤‘';
      }
    }

    // ========== í•™ìƒ ì…ì¥/í‡´ì¥ ê¸°ë¡ ==========
    
    function recordStudentJoin(studentName) {
      if (!attendanceData.isClassActive) return;
      
      const week = attendanceData.currentWeek;
      if (!attendanceData.records[week]) {
        attendanceData.records[week] = {};
      }
      
      if (!attendanceData.records[week][studentName]) {
        attendanceData.records[week][studentName] = {
          joinTime: null,
          leaveTime: null,
          status: 'not-checked',
          attendancePercent: 0
        };
      }
      
      // ì²« ì…ì¥ ì‹œê°„ë§Œ ê¸°ë¡
      if (!attendanceData.records[week][studentName].joinTime) {
        attendanceData.records[week][studentName].joinTime = new Date();
      }
      
      saveAttendanceDataLocal();
    }

    function recordStudentLeave(studentName) {
      if (!attendanceData.isClassActive) return;
      
      const week = attendanceData.currentWeek;
      if (attendanceData.records[week] && attendanceData.records[week][studentName]) {
        attendanceData.records[week][studentName].leaveTime = new Date();
        saveAttendanceDataLocal();
      }
    }

    // ========== ì¶œì„ë¶€ í‘œì‹œ ==========
    
    let attendanceRefreshInterval = null;
    
    function openAttendanceModal() {
      document.getElementById('attendanceModal').classList.add('show');
      document.getElementById('weekSelect').value = attendanceData.currentWeek;
      
      // Firebaseì—ì„œ ìµœì‹  ë°ì´í„° ë¡œë“œ í›„ ë Œë”ë§
      refreshAttendanceFromFirebase();
      
      // ìˆ˜ì—… ì¤‘ì´ë©´ 5ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
      if (attendanceData.isClassActive) {
        startAttendanceAutoRefresh();
      }
    }

    function closeAttendanceModal() {
      document.getElementById('attendanceModal').classList.remove('show');
      stopAttendanceAutoRefresh();
    }
    
    function startAttendanceAutoRefresh() {
      stopAttendanceAutoRefresh();
      attendanceRefreshInterval = setInterval(() => {
        if (attendanceData.isClassActive) {
          refreshAttendanceFromFirebase();
        } else {
          stopAttendanceAutoRefresh();
        }
      }, 5000); // 5ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
    }
    
    function stopAttendanceAutoRefresh() {
      if (attendanceRefreshInterval) {
        clearInterval(attendanceRefreshInterval);
        attendanceRefreshInterval = null;
      }
    }
    
    async function refreshAttendanceFromFirebase() {
      if (firebaseEnabled && db && currentUser.course) {
        try {
          const firebaseKey = currentUser.course.replace(/[.#$\/\[\]]/g, '_');
          const snapshot = await db.ref(`attendance/${firebaseKey}`).once('value');
          const fbData = snapshot.val();
          
          if (fbData) {
            // Firebase ë°ì´í„°ë¡œ ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
            if (fbData.records) {
              attendanceData.records = fbData.records;
            }
            if (fbData.students) {
              attendanceData.students = fbData.students;
            }
          }
        } catch (e) {
          console.error('Firebase ì¶œì„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', e);
        }
      }
      renderAttendanceTable();
    }

    function renderAttendanceTable() {
      const week = parseInt(document.getElementById('weekSelect').value);
      const tbody = document.getElementById('attendanceTableBody');
      const records = attendanceData.records[week] || {};
      
      if (attendanceData.students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#6b7280;padding:30px;">ë“±ë¡ëœ ìˆ˜ê°•ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        document.getElementById('attendanceSummary').innerHTML = '';
        return;
      }
      
      let attendingCount = 0, partialCount = 0, absentCount = 0, notCheckedCount = 0;
      
      tbody.innerHTML = attendanceData.students.map((name, index) => {
        const record = records[name] || { joinTime: null, leaveTime: null, status: 'not-checked' };
        
        // ì‹¤ì‹œê°„ ì¶œì„ ìƒíƒœ ê³„ì‚°
        const realTimeStatus = calculateRealTimeStatus(record, week);
        
        // ì¹´ìš´íŠ¸
        if (realTimeStatus.type === 'attending') attendingCount++;
        else if (realTimeStatus.type === 'partial') partialCount++;
        else if (realTimeStatus.type === 'absent') absentCount++;
        else if (realTimeStatus.type === 'not-checked') notCheckedCount++;
        
        return `
          <tr>
            <td>${index + 1}</td>
            <td>${name}</td>
            <td class="time-info">${record.joinTime ? formatTime(new Date(record.joinTime)) : '-'}</td>
            <td class="time-info">${record.leaveTime ? formatTime(new Date(record.leaveTime)) : (attendanceData.isClassActive && record.joinTime ? 'ìˆ˜ì—…ì¤‘' : '-')}</td>
            <td>
              <span class="attendance-status ${realTimeStatus.type}">${realTimeStatus.label}</span>
            </td>
          </tr>
        `;
      }).join('');
      
      // ìš”ì•½ í‘œì‹œ
      const summaryHtml = [];
      if (attendingCount > 0) {
        summaryHtml.push(`<div class="summary-item"><span class="attendance-status attending">ì¶œì„ì¤‘</span><span class="count">${attendingCount}ëª…</span></div>`);
      }
      if (partialCount > 0) {
        summaryHtml.push(`<div class="summary-item"><span class="attendance-status partial">ë¶€ë¶„ì¶œì„</span><span class="count">${partialCount}ëª…</span></div>`);
      }
      if (absentCount > 0) {
        summaryHtml.push(`<div class="summary-item"><span class="attendance-status absent">ê²°ì„</span><span class="count">${absentCount}ëª…</span></div>`);
      }
      if (notCheckedCount > 0) {
        summaryHtml.push(`<div class="summary-item"><span class="attendance-status not-checked">ë¯¸ì¶œê²°</span><span class="count">${notCheckedCount}ëª…</span></div>`);
      }
      summaryHtml.push(`<div class="summary-item" style="margin-left:auto;">ì´ <span class="count">${attendanceData.students.length}ëª…</span></div>`);
      
      document.getElementById('attendanceSummary').innerHTML = summaryHtml.join('');
    }
    
    // ì‹¤ì‹œê°„ ì¶œì„ ìƒíƒœ ê³„ì‚°
    function calculateRealTimeStatus(record, week) {
      const now = new Date();
      const isCurrentWeek = (week === attendanceData.currentWeek);
      const isClassActive = attendanceData.isClassActive && isCurrentWeek;
      const classStartTime = attendanceData.classStartTime ? new Date(attendanceData.classStartTime) : null;
      const classEndTime = attendanceData.classEndTime ? new Date(attendanceData.classEndTime) : null;
      
      // ì…ì¥ ê¸°ë¡ì´ ì—†ëŠ” ê²½ìš°
      if (!record.joinTime) {
        if (isClassActive) {
          // ìˆ˜ì—… ì¤‘ì¸ë° ì•„ì§ ì…ì¥ ì•ˆí•¨
          return { type: 'not-checked', label: 'ë¯¸ì¶œê²°' };
        } else if (classEndTime && isCurrentWeek) {
          // ìˆ˜ì—… ì¢…ë£ŒëëŠ”ë° ê¸°ë¡ ì—†ìŒ = ê²°ì„
          return { type: 'absent', label: 'ê²°ì„' };
        } else {
          // ì•„ì§ ìˆ˜ì—… ì‹œì‘ ì•ˆí•¨ or ë‹¤ë¥¸ ì£¼ì°¨
          return { type: 'not-checked', label: 'ë¯¸ì¶œê²°' };
        }
      }
      
      const joinTime = new Date(record.joinTime);
      const leaveTime = record.leaveTime ? new Date(record.leaveTime) : null;
      
      // ìˆ˜ì—…ì´ ì§„í–‰ ì¤‘ì¸ ê²½ìš°
      if (isClassActive && classStartTime) {
        if (!leaveTime) {
          // ì…ì¥í–ˆê³  ì•„ì§ í‡´ì¥ ì•ˆí•¨ = ì¶œì„ì¤‘
          return { type: 'attending', label: 'ğŸŸ¢ ì¶œì„ì¤‘' };
        } else {
          // ì…ì¥í–ˆë‹¤ê°€ ë‚˜ê° (ì¡°í‡´ ìƒíƒœë¡œ ì¶œì„ì¤‘ì— í‘œì‹œ)
          const totalClassTime = now - classStartTime;
          const attendedTime = leaveTime - joinTime;
          const percent = Math.round((attendedTime / totalClassTime) * 100);
          return { type: 'partial', label: `${Math.min(percent, 100)}% ì¶œì„` };
        }
      }
      
      // ìˆ˜ì—…ì´ ì¢…ë£Œëœ ê²½ìš° (í˜„ì¬ ì£¼ì°¨)
      if (classEndTime && isCurrentWeek && classStartTime) {
        const totalClassTime = classEndTime - classStartTime;
        const effectiveLeaveTime = leaveTime || classEndTime;
        const effectiveJoinTime = joinTime < classStartTime ? classStartTime : joinTime;
        
        // ì‹¤ì œ ì°¸ì„ ì‹œê°„ ê³„ì‚°
        let attendedTime = effectiveLeaveTime - effectiveJoinTime;
        if (attendedTime < 0) attendedTime = 0;
        
        const percent = Math.round((attendedTime / totalClassTime) * 100);
        
        if (percent >= 100) {
          return { type: 'attending', label: 'âœ… 100% ì¶œì„' };
        } else if (percent > 0) {
          return { type: 'partial', label: `${percent}% ì¶œì„` };
        } else {
          return { type: 'absent', label: 'ê²°ì„' };
        }
      }
      
      // ë‹¤ë¥¸ ì£¼ì°¨ì´ê³  ê¸°ë¡ì´ ìˆëŠ” ê²½ìš° (ê³¼ê±° ë°ì´í„°)
      if (record.status) {
        // ê¸°ì¡´ ì €ì¥ëœ ìƒíƒœê°€ ìˆìœ¼ë©´ í¼ì„¼íŠ¸ë¡œ ë³€í™˜í•´ì„œ í‘œì‹œ
        if (record.attendancePercent !== undefined) {
          const percent = record.attendancePercent;
          if (percent >= 100) return { type: 'attending', label: 'âœ… 100% ì¶œì„' };
          if (percent > 0) return { type: 'partial', label: `${percent}% ì¶œì„` };
          return { type: 'absent', label: 'ê²°ì„' };
        }
        // ë ˆê±°ì‹œ ìƒíƒœ ë³€í™˜
        const legacyMap = {
          'present': { type: 'attending', label: 'âœ… 100% ì¶œì„' },
          'late': { type: 'partial', label: 'ì§€ê°' },
          'early-leave': { type: 'partial', label: 'ì¡°í‡´' },
          'absent': { type: 'absent', label: 'ê²°ì„' },
          'pending': { type: 'not-checked', label: 'ë¯¸ì¶œê²°' },
          'not-checked': { type: 'not-checked', label: 'ë¯¸ì¶œê²°' }
        };
        return legacyMap[record.status] || { type: 'not-checked', label: 'ë¯¸ì¶œê²°' };
      }
      
      return { type: 'not-checked', label: 'ë¯¸ì¶œê²°' };
    }

    function exportAttendance() {
      const week = parseInt(document.getElementById('weekSelect').value);
      const records = attendanceData.records[week] || {};
      
      let csv = 'ë²ˆí˜¸,ì´ë¦„,ì…ì¥ì‹œê°„,í‡´ì¥ì‹œê°„,ì¶œì„ë¥ ,ì¶œì„ìƒíƒœ\n';
      
      attendanceData.students.forEach((name, index) => {
        const record = records[name] || { joinTime: null, leaveTime: null, status: 'not-checked', attendancePercent: 0 };
        const realTimeStatus = calculateRealTimeStatus(record, week);
        
        csv += `${index + 1},${name},`;
        csv += `${record.joinTime ? formatTime(new Date(record.joinTime)) : '-'},`;
        csv += `${record.leaveTime ? formatTime(new Date(record.leaveTime)) : '-'},`;
        csv += `${record.attendancePercent !== undefined ? record.attendancePercent + '%' : '-'},`;
        csv += `${realTimeStatus.label.replace(/[ğŸŸ¢âœ…]/g, '')}\n`;
      });
      
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `ì¶œì„ë¶€_${currentUser.course}_${week}ì£¼ì°¨.csv`;
      link.click();
    }

    function formatTime(date) {
      if (!date) return '-';
      return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    // ========== UI ì—…ë°ì´íŠ¸ (ì¶œì„ ê´€ë ¨) ==========
    // êµìˆ˜/í•™ìƒ ì»¨íŠ¸ë¡¤ì€ ì´ì œ í—¤ë”ì— í†µí•©ë˜ì–´ updateMainUI()ì—ì„œ ì²˜ë¦¬ë¨

    // í•™ìƒ ìë™ ì¶œì„ ì²´í¬
    function checkStudentAttendance() {
      // ê°•ì˜ ë°ì´í„° ë¡œë“œ
      const storageKey = `attendance_${currentUser.course}`;
      const saved = localStorage.getItem(storageKey);
      
      if (saved) {
        const data = JSON.parse(saved);
        if (data.isClassActive && data.students.includes(currentUser.name)) {
          // í•™ìƒì´ ìˆ˜ê°•ìƒ ëª©ë¡ì— ìˆê³  ìˆ˜ì—…ì´ ì§„í–‰ ì¤‘ì´ë©´ ì…ì¥ ê¸°ë¡
          if (!data.records[data.currentWeek]) {
            data.records[data.currentWeek] = {};
          }
          if (!data.records[data.currentWeek][currentUser.name]) {
            data.records[data.currentWeek][currentUser.name] = {
              joinTime: null,
              leaveTime: null,
              status: 'not-checked',
              attendancePercent: 0
            };
          }
          if (!data.records[data.currentWeek][currentUser.name].joinTime) {
            data.records[data.currentWeek][currentUser.name].joinTime = new Date().toISOString();
            localStorage.setItem(storageKey, JSON.stringify(data));
            console.log('ì¶œì„ ì²´í¬ë¨:', currentUser.name);
          }
        }
      }
    }

    // í•™ìƒ í‡´ì¥ ì‹œ ê¸°ë¡ (í˜ì´ì§€ ë– ë‚  ë•Œ)
    window.addEventListener('beforeunload', () => {
      if (currentUser.role === 'student' && currentUser.course) {
        const storageKey = `attendance_${currentUser.course}`;
        const saved = localStorage.getItem(storageKey);
        
        if (saved) {
          const data = JSON.parse(saved);
          if (data.isClassActive && data.records[data.currentWeek] && 
              data.records[data.currentWeek][currentUser.name]) {
            const leaveTime = new Date().toISOString();
            data.records[data.currentWeek][currentUser.name].leaveTime = leaveTime;
            localStorage.setItem(storageKey, JSON.stringify(data));
            
            // Firebaseì—ë„ ì €ì¥ (ë™ê¸°ì ìœ¼ë¡œ ì‹œë„)
            if (firebaseEnabled && db) {
              const firebaseKey = currentUser.course.replace(/[.#$\/\[\]]/g, '_');
              const updatePath = `attendance/${firebaseKey}/records/${data.currentWeek}/${currentUser.name}/leaveTime`;
              db.ref(updatePath).set(leaveTime);
              console.log('ğŸ“¤ í‡´ì¥ì‹œê°„ Firebase ì €ì¥:', leaveTime);
            }
          }
        }
      }
    });
    
    // ì¶”ê°€: visibilitychange ì´ë²¤íŠ¸ë¡œ íƒ­ ìˆ¨ê¹€ ì‹œì—ë„ ê¸°ë¡
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden' && currentUser.role === 'student' && currentUser.course) {
        const storageKey = `attendance_${currentUser.course}`;
        const saved = localStorage.getItem(storageKey);
        
        if (saved) {
          const data = JSON.parse(saved);
          if (data.isClassActive && data.records[data.currentWeek] && 
              data.records[data.currentWeek][currentUser.name]) {
            const leaveTime = new Date().toISOString();
            data.records[data.currentWeek][currentUser.name].leaveTime = leaveTime;
            localStorage.setItem(storageKey, JSON.stringify(data));
            
            // Firebaseì—ë„ ì €ì¥
            if (firebaseEnabled && db) {
              const firebaseKey = currentUser.course.replace(/[.#$\/\[\]]/g, '_');
              db.ref(`attendance/${firebaseKey}/records/${data.currentWeek}/${currentUser.name}/leaveTime`).set(leaveTime);
              console.log('ğŸ“¤ í‡´ì¥ì‹œê°„ Firebase ì €ì¥ (íƒ­ ìˆ¨ê¹€):', leaveTime);
            }
          }
        }
      }
    });

    // ========== í•™ìƒ ì¶œì„í˜„í™© ëª¨ë‹¬ ==========
    
    function openMyAttendanceModal() {
      document.getElementById('myAttendanceModal').classList.add('show');
      renderMyAttendance();
    }
    
    function closeMyAttendanceModal() {
      document.getElementById('myAttendanceModal').classList.remove('show');
    }
    
    async function renderMyAttendance() {
      document.getElementById('myCourseName').textContent = currentUser.course;
      
      // Firebase ë˜ëŠ” localStorageì—ì„œ ì¶œì„ ë°ì´í„° ë¡œë“œ
      const firebaseKey = currentUser.course.replace(/[.#$\/\[\]]/g, '_');
      let attendanceInfo = null;
      
      if (firebaseEnabled && db) {
        try {
          const snapshot = await db.ref(`attendance/${firebaseKey}`).once('value');
          attendanceInfo = snapshot.val();
        } catch (e) {
          console.error('Firebase ì¶œì„ ë¡œë“œ ì˜¤ë¥˜:', e);
        }
      }
      
      // Firebaseì— ì—†ìœ¼ë©´ localStorageì—ì„œ ë¡œë“œ
      if (!attendanceInfo) {
        const saved = localStorage.getItem(`attendance_${currentUser.course}`);
        if (saved) {
          attendanceInfo = JSON.parse(saved);
        }
      }
      
      const summaryEl = document.getElementById('myAttendanceSummary');
      const listEl = document.getElementById('myAttendanceList');
      
      console.log('ğŸ“‹ ì¶œì„ ë°ì´í„° ë¡œë“œë¨:', attendanceInfo);
      
      if (!attendanceInfo || !attendanceInfo.records) {
        console.log('âŒ ì¶œì„ recordsê°€ ì—†ìŒ');
        summaryEl.innerHTML = '';
        listEl.innerHTML = '<div style="text-align:center;padding:20px;color:#9ca3af;">ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      console.log('ğŸ“‹ records í‚¤:', Object.keys(attendanceInfo.records));
      console.log('ğŸ‘¤ í˜„ì¬ í•™ìƒ:', currentUser.name);
      
      // ë‚´ ì¶œì„ í†µê³„ ê³„ì‚°
      let present = 0, late = 0, absent = 0, earlyLeave = 0;
      const weekRecords = [];
      
      // ê°€ëŠ¥í•œ ì£¼ì°¨ í‚¤ í˜•ì‹ë“¤ í™•ì¸ ("1", "1ì£¼ì°¨", "week1" ë“±)
      const possibleWeekFormats = (week) => [`${week}`, `${week}ì£¼ì°¨`, `week${week}`];
      
      for (let week = 1; week <= 15; week++) {
        let record = null;
        let weekKey = null;
        
        // ì—¬ëŸ¬ í˜•ì‹ìœ¼ë¡œ ì‹œë„
        for (const format of possibleWeekFormats(week)) {
          if (attendanceInfo.records[format] && attendanceInfo.records[format][currentUser.name]) {
            record = attendanceInfo.records[format][currentUser.name];
            weekKey = `${week}ì£¼ì°¨`;
            break;
          }
        }
        
        if (record) {
          weekRecords.push({ week: weekKey, weekNum: week, ...record });
          
          // í¼ì„¼íŠ¸ ê¸°ë°˜ìœ¼ë¡œ í†µê³„ ê³„ì‚°
          const percent = record.attendancePercent !== undefined ? record.attendancePercent : 
            (record.status === 'present' ? 100 : record.status === 'absent' ? 0 : 50);
          
          if (percent >= 100) present++;
          else if (percent > 0) partialCount++;
          else absent++;
        }
      }
      
      let partialCount = 0; // ë¶€ë¶„ì¶œì„ ì¹´ìš´íŠ¸ ì¶”ê°€
      weekRecords.forEach(r => {
        const percent = r.attendancePercent !== undefined ? r.attendancePercent : 
          (r.status === 'present' ? 100 : r.status === 'absent' ? 0 : 50);
        if (percent >= 100) { /* ì´ë¯¸ ì¹´ìš´íŠ¸ë¨ */ }
        else if (percent > 0) partialCount++;
      });
      
      // ìš”ì•½ í‘œì‹œ (ìƒˆë¡œìš´ ìƒíƒœ ì²´ê³„)
      summaryEl.innerHTML = `
        <div style="padding:12px 16px;background:#064e3b;border-radius:8px;text-align:center;min-width:70px;">
          <div style="font-size:20px;font-weight:bold;color:#6ee7b7;">${present}</div>
          <div style="font-size:11px;color:#9ca3af;">100% ì¶œì„</div>
        </div>
        <div style="padding:12px 16px;background:#581c87;border-radius:8px;text-align:center;min-width:70px;">
          <div style="font-size:20px;font-weight:bold;color:#c084fc;">${partialCount}</div>
          <div style="font-size:11px;color:#9ca3af;">ë¶€ë¶„ì¶œì„</div>
        </div>
        <div style="padding:12px 16px;background:#7f1d1d;border-radius:8px;text-align:center;min-width:70px;">
          <div style="font-size:20px;font-weight:bold;color:#fca5a5;">${absent}</div>
          <div style="font-size:11px;color:#9ca3af;">ê²°ì„</div>
        </div>
      `;
      
      // ì£¼ì°¨ë³„ ê¸°ë¡ í‘œì‹œ
      if (weekRecords.length === 0) {
        listEl.innerHTML = '<div style="text-align:center;padding:20px;color:#9ca3af;">ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        listEl.innerHTML = `
          <table style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead>
              <tr style="border-bottom:1px solid #374151;">
                <th style="padding:10px;text-align:left;color:#9ca3af;">ì£¼ì°¨</th>
                <th style="padding:10px;text-align:center;color:#9ca3af;">ì¶œì„ë¥ </th>
                <th style="padding:10px;text-align:center;color:#9ca3af;">ì…ì¥ì‹œê°„</th>
              </tr>
            </thead>
            <tbody>
              ${weekRecords.map(r => {
                const percent = r.attendancePercent !== undefined ? r.attendancePercent : 
                  (r.status === 'present' ? 100 : r.status === 'absent' ? 0 : 50);
                const statusClass = getStatusClass(r.status, percent);
                const statusText = getStatusText(r.status, r.attendancePercent);
                return `
                <tr style="border-bottom:1px solid #1f2937;">
                  <td style="padding:10px;">${r.week}</td>
                  <td style="padding:10px;text-align:center;">
                    <span class="attendance-status ${statusClass}">${statusText}</span>
                  </td>
                  <td style="padding:10px;text-align:center;color:#9ca3af;">
                    ${r.joinTime ? new Date(r.joinTime).toLocaleTimeString('ko-KR') : '-'}
                  </td>
                </tr>
              `}).join('')}
            </tbody>
          </table>
        `;
      }
    }
    
    function getStatusText(status, percent) {
      if (percent !== undefined && percent > 0) {
        if (percent >= 100) return 'âœ… 100% ì¶œì„';
        return `${percent}% ì¶œì„`;
      }
      const statusMap = {
        'present': 'âœ… 100% ì¶œì„',
        'late': 'ì§€ê°',
        'early-leave': 'ì¡°í‡´',
        'absent': 'ê²°ì„',
        'pending': 'ë¯¸ì¶œê²°',
        'not-checked': 'ë¯¸ì¶œê²°',
        'attending': 'ğŸŸ¢ ì¶œì„ì¤‘',
        'partial': 'ë¶€ë¶„ì¶œì„'
      };
      return statusMap[status] || 'ë¯¸ì¶œê²°';
    }
    
    function getStatusClass(status, percent) {
      if (percent !== undefined) {
        if (percent >= 100) return 'attending';
        if (percent > 0) return 'partial';
        return 'absent';
      }
      const classMap = {
        'present': 'attending',
        'late': 'partial',
        'early-leave': 'partial',
        'absent': 'absent',
        'pending': 'not-checked',
        'not-checked': 'not-checked',
        'attending': 'attending',
        'partial': 'partial'
      };
      return classMap[status] || 'not-checked';
    }
    
    // í•™ìƒ ìˆ˜ë™ ì¶œì„í•˜ê¸° ë²„íŠ¼
    async function studentCheckIn() {
      const firebaseKey = currentUser.course.replace(/[.#$\/\[\]]/g, '_');
      let attendanceInfo = null;
      
      // Firebaseì—ì„œ ì¶œì„ ë°ì´í„° ë¡œë“œ
      if (firebaseEnabled && db) {
        try {
          const snapshot = await db.ref(`attendance/${firebaseKey}`).once('value');
          attendanceInfo = snapshot.val();
        } catch (e) {
          console.error('Firebase ì¶œì„ ë¡œë“œ ì˜¤ë¥˜:', e);
        }
      }
      
      // localStorageì—ì„œë„ í™•ì¸
      if (!attendanceInfo) {
        const saved = localStorage.getItem(`attendance_${currentUser.course}`);
        if (saved) {
          attendanceInfo = JSON.parse(saved);
        }
      }
      
      if (!attendanceInfo) {
        alert('ì¶œì„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nêµìˆ˜ë‹˜ì´ ìˆ˜ì—…ì„ ì‹œì‘í•˜ë©´ ìë™ìœ¼ë¡œ ì¶œì„ë©ë‹ˆë‹¤.');
        return;
      }
      
      if (!attendanceInfo.isClassActive) {
        alert('í˜„ì¬ ìˆ˜ì—…ì´ ì§„í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.\nêµìˆ˜ë‹˜ì´ ìˆ˜ì—…ì„ ì‹œì‘í•˜ë©´ ì¶œì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      const weekKey = attendanceInfo.currentWeek;
      if (!attendanceInfo.records) attendanceInfo.records = {};
      if (!attendanceInfo.records[weekKey]) attendanceInfo.records[weekKey] = {};
      
      if (attendanceInfo.records[weekKey][currentUser.name]?.joinTime) {
        alert('ì´ë¯¸ ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        return;
      }
      
      // ì¶œì„ ê¸°ë¡
      attendanceInfo.records[weekKey][currentUser.name] = {
        joinTime: new Date().toISOString(),
        leaveTime: null,
        status: 'present'
      };
      
      // Firebaseì— ì €ì¥
      if (firebaseEnabled && db) {
        try {
          await db.ref(`attendance/${firebaseKey}`).set(attendanceInfo);
          console.log('ğŸ“¤ ì¶œì„ Firebase ì €ì¥ ì™„ë£Œ');
        } catch (e) {
          console.error('Firebase ì €ì¥ ì˜¤ë¥˜:', e);
        }
      }
      
      // localStorageì—ë„ ì €ì¥
      localStorage.setItem(`attendance_${currentUser.course}`, JSON.stringify(attendanceInfo));
      
      alert('âœ… ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
      
      // ì¶œì„í•˜ê¸° ë²„íŠ¼ ë¹„í™œì„±í™”
      const btnCheckIn = document.getElementById('btnCheckIn');
      if (btnCheckIn) {
        btnCheckIn.disabled = true;
        btnCheckIn.textContent = 'âœ… ì¶œì„ì™„ë£Œ';
      }
    }

    // ========== Firebase ì§„ë‹¨ ê¸°ëŠ¥ ==========
    
    async function checkFirebaseStatus() {
      let report = '===== Firebase ì§„ë‹¨ ê²°ê³¼ =====\n\n';
      
      // 1. Firebase ì—°ê²° ìƒíƒœ
      report += `1. Firebase í™œì„±í™”: ${firebaseEnabled ? 'âœ… ì˜ˆ' : 'âŒ ì•„ë‹ˆì˜¤'}\n`;
      report += `2. DB ê°ì²´: ${db ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ'}\n\n`;
      
      // 2. ê°•ì˜ ë°ì´í„° í™•ì¸
      report += '===== ê°•ì˜ ë°ì´í„° =====\n';
      report += `ë¡œì»¬ ê°•ì˜ ìˆ˜: ${courseData.length}ê°œ\n`;
      if (courseData.length > 0) {
        courseData.forEach(c => {
          report += `  - ${c.name} (êµìˆ˜: ${c.professor}, í•™ìƒ: ${c.students?.length || 0}ëª…)\n`;
        });
      }
      
      // 3. Firebaseì—ì„œ ì§ì ‘ ì½ê¸° í…ŒìŠ¤íŠ¸
      if (firebaseEnabled && db) {
        report += '\n===== Firebase ì§ì ‘ ì¡°íšŒ =====\n';
        
        try {
          // ê°•ì˜ ë°ì´í„°
          const coursesSnapshot = await db.ref('courses').once('value');
          const firebaseCourses = coursesSnapshot.val();
          if (firebaseCourses) {
            const courseList = Object.values(firebaseCourses);
            report += `Firebase ê°•ì˜ ìˆ˜: ${courseList.length}ê°œ\n`;
            courseList.forEach(c => {
              report += `  - ${c.name} (êµìˆ˜: ${c.professor}, í•™ìƒ: ${c.students?.length || 0}ëª…)\n`;
            });
          } else {
            report += 'Firebase ê°•ì˜: ì—†ìŒ (null)\n';
          }
          
          // ì¶œì„ ë°ì´í„°
          const attendanceSnapshot = await db.ref('attendance').once('value');
          const firebaseAttendance = attendanceSnapshot.val();
          report += `\nFirebase ì¶œì„ ë°ì´í„°:\n`;
          if (firebaseAttendance) {
            Object.keys(firebaseAttendance).forEach(key => {
              const att = firebaseAttendance[key];
              report += `  - ${key}: ìˆ˜ì—…ì¤‘=${att.isClassActive}, ì£¼ì°¨=${att.currentWeek || 'ì—†ìŒ'}\n`;
              if (att.records) {
                Object.keys(att.records).forEach(week => {
                  const weekData = att.records[week];
                  const studentCount = Object.keys(weekData).length;
                  report += `    ${week}: ${studentCount}ëª… ê¸°ë¡\n`;
                });
              }
            });
          } else {
            report += '  ì—†ìŒ (null)\n';
          }
          
          // í™œì„± ê°•ì˜ì‹¤
          const activeRoomsSnapshot = await db.ref('activeRooms').once('value');
          const activeRooms = activeRoomsSnapshot.val();
          report += `\nFirebase í™œì„± ê°•ì˜ì‹¤:\n`;
          if (activeRooms) {
            Object.keys(activeRooms).forEach(key => {
              const room = activeRooms[key];
              report += `  - ${key}: ì„œë²„=${room.server}, êµìˆ˜=${room.professor}\n`;
            });
          } else {
            report += '  ì—†ìŒ\n';
          }
          
        } catch (err) {
          report += `Firebase ì¡°íšŒ ì˜¤ë¥˜: ${err.message}\n`;
        }
      }
      
      // 4. localStorage í™•ì¸
      report += '\n===== localStorage ë°ì´í„° =====\n';
      const localCourses = localStorage.getItem('gcu_courses');
      report += `ë¡œì»¬ ê°•ì˜: ${localCourses ? JSON.parse(localCourses).length + 'ê°œ' : 'ì—†ìŒ'}\n`;
      
      // ì¶œì„ ë°ì´í„° í‚¤ í™•ì¸
      const attendanceKeys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('attendance_')) {
          attendanceKeys.push(key);
        }
      }
      report += `ë¡œì»¬ ì¶œì„ ë°ì´í„°: ${attendanceKeys.length}ê°œ\n`;
      attendanceKeys.forEach(key => {
        const data = JSON.parse(localStorage.getItem(key));
        report += `  - ${key}: ìˆ˜ì—…ì¤‘=${data.isClassActive}, ì£¼ì°¨=${data.currentWeek || 'ì—†ìŒ'}\n`;
      });
      
      report += '\n===== ì§„ë‹¨ ì™„ë£Œ =====';
      
      console.log(report);
      alert(report);
    }
    
    // í…ŒìŠ¤íŠ¸ìš©: Firebaseì— ë°ì´í„° ì“°ê¸° í…ŒìŠ¤íŠ¸
    async function testFirebaseWrite() {
      if (!firebaseEnabled || !db) {
        alert('Firebaseê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const testData = {
        test: true,
        timestamp: Date.now(),
        message: 'Firebase ì“°ê¸° í…ŒìŠ¤íŠ¸'
      };
      
      try {
        await db.ref('_test').set(testData);
        alert('âœ… Firebase ì“°ê¸° ì„±ê³µ!\n\në°ì´í„°: ' + JSON.stringify(testData));
        
        // ë°”ë¡œ ì½ê¸° í…ŒìŠ¤íŠ¸
        const snapshot = await db.ref('_test').once('value');
        const readData = snapshot.val();
        console.log('ì½ê¸° í…ŒìŠ¤íŠ¸:', readData);
        
        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ
        await db.ref('_test').remove();
      } catch (err) {
        alert('âŒ Firebase ì“°ê¸° ì‹¤íŒ¨!\n\nì˜¤ë¥˜: ' + err.message);
      }
    }

    // ========== ì˜ìƒí¸ì§‘ ê¸°ëŠ¥ ==========
    let ffmpeg = null;
    let ffmpegLoaded = false;
    let mergeFiles = [];
    let splitFile = null;
    let trimFile = null;
    let volumeFile = null;
    let splitOption = 'count';

    // FFmpeg ë¡œë“œ
    async function loadFFmpeg() {
      if (ffmpegLoaded) return true;
      
      try {
        // FFmpeg.wasm CDNì—ì„œ ë¡œë“œ
        if (!window.FFmpeg) {
          const script = document.createElement('script');
          script.src = 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js';
          document.head.appendChild(script);
          
          await new Promise((resolve, reject) => {
            script.onload = resolve;
            script.onerror = reject;
          });
        }
        
        const { FFmpeg } = FFmpegWASM;
        ffmpeg = new FFmpeg();
        
        ffmpeg.on('progress', ({ progress }) => {
          const percent = Math.round(progress * 100);
          updateAllProgress(percent);
        });
        
        await ffmpeg.load({
          coreURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js',
          wasmURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.wasm'
        });
        
        ffmpegLoaded = true;
        console.log('âœ… FFmpeg ë¡œë“œ ì™„ë£Œ');
        return true;
      } catch (error) {
        console.error('âŒ FFmpeg ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ì˜ìƒí¸ì§‘ ê¸°ëŠ¥ì„ ë¡œë“œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return false;
      }
    }

    function updateAllProgress(percent) {
      ['merge', 'split', 'trim', 'volume'].forEach(type => {
        const fill = document.getElementById(`${type}ProgressFill`);
        const text = document.getElementById(`${type}ProgressText`);
        if (fill) fill.style.width = `${percent}%`;
        if (text) text.textContent = `ì²˜ë¦¬ ì¤‘... ${percent}%`;
      });
    }

    // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    function openVideoEditorModal() {
      document.getElementById('videoEditorModal').classList.add('show');
    }

    function closeVideoEditorModal() {
      document.getElementById('videoEditorModal').classList.remove('show');
      // ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
      resetAllPreviews();
    }

    function resetAllPreviews() {
      mergeFiles = [];
      splitFile = null;
      trimFile = null;
      volumeFile = null;
      
      document.getElementById('mergeVideoList').innerHTML = '';
      document.getElementById('btnMergeVideos').disabled = true;
      
      document.getElementById('splitPreviewContainer').style.display = 'none';
      document.getElementById('splitVideoInfo').style.display = 'none';
      document.getElementById('btnSplitVideo').disabled = true;
      
      document.getElementById('trimPreviewContainer').style.display = 'none';
      document.getElementById('trimControls').style.display = 'none';
      document.getElementById('btnTrimVideo').disabled = true;
      
      document.getElementById('volumePreviewContainer').style.display = 'none';
      document.getElementById('volumeControls').style.display = 'none';
      document.getElementById('btnBoostVolume').disabled = true;
    }

    // íƒ­ ì „í™˜
    function switchVideoTab(tabName) {
      document.querySelectorAll('.video-editor-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.video-editor-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      
      event.currentTarget.classList.add('active');
      document.getElementById(`panel${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
    }

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
    function setupDropZone(zoneId, handler) {
      const zone = document.getElementById(zoneId);
      if (!zone) return;
      
      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
      });
      
      zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
      });
      
      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        handler(e.dataTransfer.files);
      });
    }

    // ë“œë¡­ì¡´ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      setupDropZone('mergeDropZone', (files) => handleMergeFilesInternal(files));
      setupDropZone('splitDropZone', (files) => handleSplitFileInternal(files[0]));
      setupDropZone('trimDropZone', (files) => handleTrimFileInternal(files[0]));
      setupDropZone('volumeDropZone', (files) => handleVolumeFileInternal(files[0]));
    });

    // ===== ì˜ìƒ ê²°í•© =====
    function handleMergeFiles(event) {
      handleMergeFilesInternal(event.target.files);
    }

    function handleMergeFilesInternal(files) {
      for (const file of files) {
        if (file.type.startsWith('video/')) {
          mergeFiles.push(file);
        }
      }
      renderMergeList();
    }

    function renderMergeList() {
      const listEl = document.getElementById('mergeVideoList');
      
      if (mergeFiles.length === 0) {
        listEl.innerHTML = '';
        document.getElementById('btnMergeVideos').disabled = true;
        return;
      }
      
      listEl.innerHTML = mergeFiles.map((file, index) => `
        <div class="video-list-item">
          <span class="video-icon">ğŸ¬</span>
          <div class="video-info">
            <div class="video-name">${file.name}</div>
            <div class="video-size">${formatFileSize(file.size)}</div>
          </div>
          <div class="video-order">
            <button class="order-btn" onclick="moveMergeFile(${index}, -1)" ${index === 0 ? 'disabled' : ''}>â¬†ï¸</button>
            <button class="order-btn" onclick="moveMergeFile(${index}, 1)" ${index === mergeFiles.length - 1 ? 'disabled' : ''}>â¬‡ï¸</button>
          </div>
          <button class="delete-btn" onclick="removeMergeFile(${index})">ğŸ—‘ï¸</button>
        </div>
      `).join('');
      
      document.getElementById('btnMergeVideos').disabled = mergeFiles.length < 2;
    }

    function moveMergeFile(index, direction) {
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= mergeFiles.length) return;
      
      [mergeFiles[index], mergeFiles[newIndex]] = [mergeFiles[newIndex], mergeFiles[index]];
      renderMergeList();
    }

    function removeMergeFile(index) {
      mergeFiles.splice(index, 1);
      renderMergeList();
    }

    async function mergeVideos() {
      if (mergeFiles.length < 2) {
        alert('ìµœì†Œ 2ê°œì˜ ì˜ìƒì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
        return;
      }

      const btn = document.getElementById('btnMergeVideos');
      const progress = document.getElementById('mergeProgress');
      
      btn.disabled = true;
      btn.innerHTML = 'â³ ì²˜ë¦¬ ì¤‘...';
      progress.classList.add('show');

      try {
        // FFmpeg ì—†ì´ Blob ê¸°ë°˜ ê°„ë‹¨ ê²°í•© (ë™ì¼ ì½”ë± ê°€ì •)
        const blobs = [];
        for (const file of mergeFiles) {
          blobs.push(await file.arrayBuffer());
        }
        
        // ë‹¨ìˆœ ê²°í•© ë°©ì‹ - MediaSourceë¥¼ ì‚¬ìš©í•œ ê²°í•©
        const mergedBlob = new Blob(blobs.map(b => new Uint8Array(b)), { type: mergeFiles[0].type });
        
        // ë‹¤ìš´ë¡œë“œ
        const url = URL.createObjectURL(mergedBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `merged_${Date.now()}.${getFileExtension(mergeFiles[0].name)}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('âœ… ì˜ìƒ ê²°í•©ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì°¸ê³ : ë™ì¼í•œ ì½”ë±ì˜ ì˜ìƒë§Œ ì •ìƒì ìœ¼ë¡œ ê²°í•©ë©ë‹ˆë‹¤.\në‹¤ë¥¸ í˜•ì‹ì˜ ì˜ìƒì€ ì „ë¬¸ í¸ì§‘ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
        
      } catch (error) {
        console.error('ì˜ìƒ ê²°í•© ì˜¤ë¥˜:', error);
        alert('ì˜ìƒ ê²°í•© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\në¸Œë¼ìš°ì €ì—ì„œ ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹ì´ê±°ë‚˜ íŒŒì¼ì´ ë„ˆë¬´ í´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”— ì˜ìƒ ê²°í•©í•˜ê¸°';
        progress.classList.remove('show');
      }
    }

    // ===== ì˜ìƒ ë¶„ë¦¬ =====
    function handleSplitFile(event) {
      handleSplitFileInternal(event.target.files[0]);
    }

    function handleSplitFileInternal(file) {
      if (!file || !file.type.startsWith('video/')) {
        alert('ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      splitFile = file;
      
      const video = document.getElementById('splitPreview');
      video.src = URL.createObjectURL(file);
      document.getElementById('splitPreviewContainer').style.display = 'block';
      
      video.onloadedmetadata = () => {
        document.getElementById('splitFileName').textContent = file.name;
        document.getElementById('splitFileDuration').textContent = `(${formatDuration(video.duration)})`;
        document.getElementById('splitVideoInfo').style.display = 'block';
        document.getElementById('btnSplitVideo').disabled = false;
      };
    }

    function selectSplitOption(option) {
      splitOption = option;
      
      document.querySelectorAll('.split-option').forEach(el => el.classList.remove('active'));
      event.currentTarget.classList.add('active');
      
      document.getElementById('splitCountInput').style.display = option === 'count' ? 'flex' : 'none';
      document.getElementById('splitTimeInput').style.display = option === 'time' ? 'flex' : 'none';
    }

    async function splitVideo() {
      if (!splitFile) {
        alert('ë¶„ë¦¬í•  ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const video = document.getElementById('splitPreview');
      const duration = video.duration;
      
      let splitPoints = [];
      
      if (splitOption === 'count') {
        const count = parseInt(document.getElementById('splitCount').value) || 2;
        const segmentDuration = duration / count;
        for (let i = 1; i < count; i++) {
          splitPoints.push(segmentDuration * i);
        }
      } else {
        const interval = parseInt(document.getElementById('splitInterval').value) || 300;
        for (let t = interval; t < duration; t += interval) {
          splitPoints.push(t);
        }
      }

      const btn = document.getElementById('btnSplitVideo');
      const progress = document.getElementById('splitProgress');
      
      btn.disabled = true;
      btn.innerHTML = 'â³ ì²˜ë¦¬ ì¤‘...';
      progress.classList.add('show');

      try {
        // ë¶„í•  í¬ì¸íŠ¸ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´
        if (splitPoints.length === 0) {
          alert('ì˜ìƒì´ ë„ˆë¬´ ì§§ì•„ ë¶„ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ê°„ë‹¨í•œ ë°©ì‹: ê° êµ¬ê°„ë³„ë¡œ Blob slice (ì‹¤ì œë¡œëŠ” re-encoding í•„ìš”)
        const segments = [];
        const fileBuffer = await splitFile.arrayBuffer();
        const segmentCount = splitPoints.length + 1;
        const bytesPerSecond = fileBuffer.byteLength / duration;
        
        let startTime = 0;
        for (let i = 0; i <= splitPoints.length; i++) {
          const endTime = i < splitPoints.length ? splitPoints[i] : duration;
          const startByte = Math.floor(startTime * bytesPerSecond);
          const endByte = Math.floor(endTime * bytesPerSecond);
          
          segments.push({
            data: fileBuffer.slice(startByte, endByte),
            index: i + 1
          });
          
          startTime = endTime;
          
          // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
          const percent = Math.round(((i + 1) / segmentCount) * 100);
          document.getElementById('splitProgressFill').style.width = `${percent}%`;
          document.getElementById('splitProgressText').textContent = `ë¶„ë¦¬ ì¤‘... ${i + 1}/${segmentCount}`;
        }
        
        // ê° ì„¸ê·¸ë¨¼íŠ¸ ë‹¤ìš´ë¡œë“œ
        const ext = getFileExtension(splitFile.name);
        const baseName = splitFile.name.replace(`.${ext}`, '');
        
        for (const seg of segments) {
          const blob = new Blob([new Uint8Array(seg.data)], { type: splitFile.type });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${baseName}_part${seg.index}.${ext}`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          // ë‹¤ìš´ë¡œë“œ ê°„ê²©
          await new Promise(r => setTimeout(r, 500));
        }
        
        alert(`âœ… ì˜ìƒì´ ${segmentCount}ê°œë¡œ ë¶„ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì°¸ê³ : ë‹¨ìˆœ ë¶„ë¦¬ ë°©ì‹ì…ë‹ˆë‹¤.\nì •í™•í•œ ì‹œê°„ ê¸°ì¤€ ë¶„ë¦¬ëŠ” ì „ë¬¸ í¸ì§‘ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.`);
        
      } catch (error) {
        console.error('ì˜ìƒ ë¶„ë¦¬ ì˜¤ë¥˜:', error);
        alert('ì˜ìƒ ë¶„ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'âœ‚ï¸ ì˜ìƒ ë¶„ë¦¬í•˜ê¸°';
        progress.classList.remove('show');
      }
    }

    // ===== íŠ¸ë¦¼ & ìë¥´ê¸° =====
    function handleTrimFile(event) {
      handleTrimFileInternal(event.target.files[0]);
    }

    function handleTrimFileInternal(file) {
      if (!file || !file.type.startsWith('video/')) {
        alert('ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      trimFile = file;
      
      const video = document.getElementById('trimPreview');
      video.src = URL.createObjectURL(file);
      document.getElementById('trimPreviewContainer').style.display = 'block';
      
      video.onloadedmetadata = () => {
        const duration = video.duration;
        document.getElementById('trimTotalDuration').textContent = formatDuration(duration);
        document.getElementById('trimStartTime').value = '00:00:00';
        document.getElementById('trimEndTime').value = formatDurationHMS(duration);
        document.getElementById('trimControls').style.display = 'block';
        document.getElementById('btnTrimVideo').disabled = false;
        updateTrimPreview();
      };
    }

    function setTrimStart() {
      const video = document.getElementById('trimPreview');
      document.getElementById('trimStartTime').value = formatDurationHMS(video.currentTime);
      updateTrimPreview();
    }

    function setTrimEnd() {
      const video = document.getElementById('trimPreview');
      document.getElementById('trimEndTime').value = formatDurationHMS(video.currentTime);
      updateTrimPreview();
    }

    function updateTrimPreview() {
      const startTime = parseTimeToSeconds(document.getElementById('trimStartTime').value);
      const endTime = parseTimeToSeconds(document.getElementById('trimEndTime').value);
      const duration = endTime - startTime;
      
      if (duration > 0) {
        document.getElementById('trimDurationDisplay').textContent = `ì¶”ì¶œ ê¸¸ì´: ${formatDuration(duration)}`;
      } else {
        document.getElementById('trimDurationDisplay').textContent = 'ì¶”ì¶œ ê¸¸ì´: ìœ íš¨í•˜ì§€ ì•ŠìŒ';
      }
    }

    async function trimVideo() {
      if (!trimFile) {
        alert('ìë¥¼ ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const startTime = parseTimeToSeconds(document.getElementById('trimStartTime').value);
      const endTime = parseTimeToSeconds(document.getElementById('trimEndTime').value);
      
      if (startTime >= endTime) {
        alert('ì¢…ë£Œ ì‹œê°„ì´ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      const btn = document.getElementById('btnTrimVideo');
      const progress = document.getElementById('trimProgress');
      
      btn.disabled = true;
      btn.innerHTML = 'â³ ì²˜ë¦¬ ì¤‘...';
      progress.classList.add('show');

      try {
        const video = document.getElementById('trimPreview');
        const duration = video.duration;
        
        // ë°”ì´íŠ¸ ê¸°ë°˜ ì¶”ì¶œ (ê·¼ì‚¬ì¹˜)
        const fileBuffer = await trimFile.arrayBuffer();
        const bytesPerSecond = fileBuffer.byteLength / duration;
        
        const startByte = Math.floor(startTime * bytesPerSecond);
        const endByte = Math.floor(endTime * bytesPerSecond);
        
        const trimmedBuffer = fileBuffer.slice(startByte, endByte);
        
        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        document.getElementById('trimProgressFill').style.width = '100%';
        document.getElementById('trimProgressText').textContent = 'ì™„ë£Œ!';
        
        // ë‹¤ìš´ë¡œë“œ
        const ext = getFileExtension(trimFile.name);
        const baseName = trimFile.name.replace(`.${ext}`, '');
        
        const blob = new Blob([new Uint8Array(trimmedBuffer)], { type: trimFile.type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${baseName}_trimmed.${ext}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert(`âœ… ì˜ìƒ ìë¥´ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì¶”ì¶œ êµ¬ê°„: ${formatDurationHMS(startTime)} ~ ${formatDurationHMS(endTime)}\n\nì°¸ê³ : ë‹¨ìˆœ ìë¥´ê¸° ë°©ì‹ì…ë‹ˆë‹¤.\nì •í™•í•œ í”„ë ˆì„ ë‹¨ìœ„ ìë¥´ê¸°ëŠ” ì „ë¬¸ í¸ì§‘ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.`);
        
      } catch (error) {
        console.error('ì˜ìƒ ìë¥´ê¸° ì˜¤ë¥˜:', error);
        alert('ì˜ìƒ ìë¥´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ¯ ì˜ìƒ ìë¥´ê¸°';
        progress.classList.remove('show');
      }
    }

    // ===== ì†Œë¦¬ í‚¤ì›€ =====
    function handleVolumeFile(event) {
      handleVolumeFileInternal(event.target.files[0]);
    }

    function handleVolumeFileInternal(file) {
      if (!file || !file.type.startsWith('video/')) {
        alert('ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      volumeFile = file;
      
      const video = document.getElementById('volumePreview');
      video.src = URL.createObjectURL(file);
      document.getElementById('volumePreviewContainer').style.display = 'block';
      
      video.onloadedmetadata = () => {
        document.getElementById('volumeControls').style.display = 'block';
        document.getElementById('btnBoostVolume').disabled = false;
      };
    }

    function updateVolumeDisplay() {
      const value = document.getElementById('volumeSlider').value;
      document.getElementById('volumeValue').textContent = `${value}%`;
      
      // ë¯¸ë¦¬ë³´ê¸° ë³¼ë¥¨ ì ìš©
      const video = document.getElementById('volumePreview');
      video.volume = Math.min(value / 100, 1);
    }

    async function boostVolume() {
      if (!volumeFile) {
        alert('ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const volumeMultiplier = parseInt(document.getElementById('volumeSlider').value) / 100;
      
      const btn = document.getElementById('btnBoostVolume');
      const progress = document.getElementById('volumeProgress');
      
      btn.disabled = true;
      btn.innerHTML = 'â³ ì²˜ë¦¬ ì¤‘...';
      progress.classList.add('show');

      try {
        // Web Audio APIë¥¼ ì‚¬ìš©í•œ ì˜¤ë””ì˜¤ ì¦í­
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const video = document.getElementById('volumePreview');
        
        document.getElementById('volumeProgressFill').style.width = '30%';
        document.getElementById('volumeProgressText').textContent = 'ì˜¤ë””ì˜¤ ë¶„ì„ ì¤‘...';
        
        // ë¹„ë””ì˜¤ì—ì„œ ì˜¤ë””ì˜¤ ì¶”ì¶œ ë° ì¦í­ì€ ë³µì¡í•˜ë¯€ë¡œ,
        // ê°„ë‹¨í•œ ë°©ì‹ìœ¼ë¡œ íŒŒì¼ì„ ê·¸ëŒ€ë¡œ ì €ì¥í•˜ê³  ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
        
        document.getElementById('volumeProgressFill').style.width = '100%';
        document.getElementById('volumeProgressText').textContent = 'ì™„ë£Œ!';
        
        // ì›ë³¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ë³¼ë¥¨ ì„¤ì • ì•ˆë‚´ì™€ í•¨ê»˜)
        const url = URL.createObjectURL(volumeFile);
        const a = document.createElement('a');
        a.href = url;
        const ext = getFileExtension(volumeFile.name);
        const baseName = volumeFile.name.replace(`.${ext}`, '');
        a.download = `${baseName}_volume_boost.${ext}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert(`âœ… íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ”Š ë³¼ë¥¨ ì¦í­ ì„¤ì •: ${volumeMultiplier * 100}%\n\nğŸ’¡ ì‹¤ì œ ë³¼ë¥¨ ì¦í­ì„ ìœ„í•´ì„œëŠ”:\n1. VLC ë¯¸ë””ì–´ í”Œë ˆì´ì–´ì—ì„œ ì˜¤ë””ì˜¤ > ë³¼ë¥¨ ì¡°ì ˆ\n2. ë˜ëŠ” ë¬´ë£Œ í”„ë¡œê·¸ë¨ Audacity ì‚¬ìš©\n3. ë˜ëŠ” ì˜ìƒí¸ì§‘ í”„ë¡œê·¸ë¨ì—ì„œ ì˜¤ë””ì˜¤ ê²Œì¸ ì¡°ì ˆ\n\në¸Œë¼ìš°ì € ê¸°ë°˜ ë³¼ë¥¨ ì¦í­ì€ ê¸°ìˆ ì  í•œê³„ê°€ ìˆì–´\nì „ë¬¸ ë„êµ¬ ì‚¬ìš©ì„ ê¶Œì¥ë“œë¦½ë‹ˆë‹¤.`);
        
      } catch (error) {
        console.error('ë³¼ë¥¨ ì¡°ì ˆ ì˜¤ë¥˜:', error);
        alert('ë³¼ë¥¨ ì¡°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”Š ì†Œë¦¬ í‚¤ìš°ê¸°';
        progress.classList.remove('show');
      }
    }

    // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
    }

    function formatDuration(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      
      if (h > 0) {
        return `${h}ì‹œê°„ ${m}ë¶„ ${s}ì´ˆ`;
      } else if (m > 0) {
        return `${m}ë¶„ ${s}ì´ˆ`;
      }
      return `${s}ì´ˆ`;
    }

    function formatDurationHMS(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function parseTimeToSeconds(timeStr) {
      const parts = timeStr.split(':').map(Number);
      if (parts.length === 3) {
        return parts[0] * 3600 + parts[1] * 60 + parts[2];
      } else if (parts.length === 2) {
        return parts[0] * 60 + parts[1];
      }
      return Number(timeStr) || 0;
    }

    function getFileExtension(filename) {
      return filename.split('.').pop().toLowerCase();
    }

    // ========== PWA ì„¤ì¹˜ ê¸°ëŠ¥ ==========
    let deferredPrompt = null;

    // Service Worker ë“±ë¡
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((registration) => {
            console.log('Service Worker ë“±ë¡ ì„±ê³µ:', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
          });
      });
    }

    // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì´ë²¤íŠ¸ ìº¡ì²˜ (Android/Chrome/Edge)
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ
      const installBtn = document.getElementById('installBtn');
      installBtn.classList.add('show');
    });

    // iOS ê°ì§€ ë° ê°€ì´ë“œ í‘œì‹œ
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }

    function isInStandaloneMode() {
      return window.matchMedia('(display-mode: standalone)').matches || 
             window.navigator.standalone === true;
    }

    // iOSì—ì„œ Safari ë¸Œë¼ìš°ì €ì¸ ê²½ìš° ê°€ì´ë“œ í‘œì‹œ
    if (isIOS() && !isInStandaloneMode()) {
      const iosGuide = document.getElementById('iosGuide');
      iosGuide.classList.add('show');
    }

    // ì•± ì„¤ì¹˜ í•¨ìˆ˜
    async function installApp() {
      if (!deferredPrompt) {
        alert('ì´ë¯¸ ì„¤ì¹˜ë˜ì—ˆê±°ë‚˜ ì„¤ì¹˜í•  ìˆ˜ ì—†ëŠ” í™˜ê²½ì…ë‹ˆë‹¤.');
        return;
      }

      // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
      deferredPrompt.prompt();
      
      const { outcome } = await deferredPrompt.userChoice;
      console.log('ì„¤ì¹˜ ê²°ê³¼:', outcome);
      
      if (outcome === 'accepted') {
        document.getElementById('installBtn').classList.remove('show');
      }
      
      deferredPrompt = null;
    }

    // ì„¤ì¹˜ ì™„ë£Œ ì´ë²¤íŠ¸
    window.addEventListener('appinstalled', () => {
      console.log('ì•±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤!');
      document.getElementById('installBtn').classList.remove('show');
      deferredPrompt = null;
    });
  </script>
</body>
</html>

